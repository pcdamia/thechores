{% extends "base.html" %}

{% block title %}Dashboard - The Chores{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="dashboard" id="dashboard-container" data-authenticated="{{ 'true' if current_user.is_authenticated else 'false' }}" data-admin="{{ 'true' if current_user.is_authenticated and current_user.is_admin else 'false' }}" data-user-id="{{ current_user.id if current_user.is_authenticated else '' }}" data-user-name="{{ (current_user.name or 'Guest')|e if current_user.is_authenticated else 'Guest' }}">
    <!-- Date/Time and Weather - Split for authenticated users -->
    {% if current_user.is_authenticated %}
    <div class="dashboard-header draggable-section" data-section="header" draggable="true" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div class="glass-card header-card">
            <div class="drag-handle">‚ãÆ‚ãÆ</div>
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                <div class="date-time">
                    <div id="current-date" class="date-display"></div>
                    <div id="current-time" class="time-display"></div>
                </div>
                <div class="weather">
                    <div id="weather-icon">‚òÄÔ∏è</div>
                    <div id="weather-info">
                        <div id="weather-temp">--¬∞F</div>
                        <div id="weather-desc">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="greeting-in-card">
                <h2 id="greeting" class="greeting-text">Good morning, {{ current_user.name or 'User' }}!</h2>
            </div>
        </div>
        <div class="glass-card header-card">
            <div class="drag-handle">‚ãÆ‚ãÆ</div>
            <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: var(--text-primary);">Upcoming Tasks</h3>
            <div id="upcoming-tasks" style="max-height: 120px; overflow-y: auto;">
                <p style="color: var(--text-secondary); font-size: 14px;">Loading...</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="dashboard-header draggable-section" data-section="header" draggable="true">
        <div class="glass-card header-card">
            <div class="drag-handle">‚ãÆ‚ãÆ</div>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px;">
                <div class="date-time">
                    <div id="current-date" class="date-display"></div>
                    <div id="current-time" class="time-display"></div>
                </div>
                <div class="weather">
                    <div id="weather-icon">‚òÄÔ∏è</div>
                    <div id="weather-info">
                        <div id="weather-temp">--¬∞F</div>
                        <div id="weather-desc">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="greeting-in-card">
                <h2 id="greeting" class="greeting-text">Good morning, Guest!</h2>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if current_user.is_authenticated %}
    <!-- Quick Action Cards - Horizontal (authenticated only) -->
    <div class="quick-actions draggable-section" data-section="actions" draggable="true">
        <div class="glass-card quick-action-card" onclick="window.location.href='/chores'">
            <div class="action-icon">‚úÖ</div>
            <h3>Chores</h3>
            <p id="pending-chores-count">-</p>
        </div>
        <div class="glass-card quick-action-card" onclick="window.location.href='/items'">
            <div class="action-icon">üì¶</div>
            <h3>Inventory</h3>
            <p id="low-stock-count">-</p>
        </div>
        <div class="glass-card quick-action-card" onclick="window.location.href='/events'">
            <div class="action-icon">üìÖ</div>
            <h3>Events</h3>
            <p id="events-count">-</p>
        </div>
        <div class="glass-card quick-action-card" onclick="window.location.href='/shopping-lists'">
            <div class="action-icon">üõí</div>
            <h3>Shopping Lists</h3>
            <p id="shopping-lists-count">-</p>
        </div>
    </div>
    
    <!-- Quick Events and Quick Chores - two separate cards, responsive (stack on narrow) -->
    <div class="magnets-section draggable-section magnets-grid" data-section="magnets" draggable="true">
        <div class="glass-card magnets-card magnets-card-standalone">
            <div class="drag-handle">‚ãÆ‚ãÆ</div>
            <div class="magnets-column-header">
                <h3>Quick Events</h3>
                <button type="button" class="btn-add-magnet" id="add-quick-event-btn" title="Edit quick events (max 8)">+ Add</button>
            </div>
            <div class="magnets-container" id="quick-events-container"></div>
        </div>
        <div class="glass-card magnets-card magnets-card-standalone">
            <div class="magnets-column-header">
                <h3>Quick Chores</h3>
                <button type="button" class="btn-add-magnet" id="add-quick-chore-btn" title="Edit quick chores (max 8)">+ Add</button>
            </div>
            <div class="magnets-container" id="quick-chores-container"></div>
        </div>
    </div>
    {% endif %}
    
    <!-- Calendar - Full Width -->
    <div class="calendar-section draggable-section" data-section="calendar" draggable="true">
        <div class="glass-card calendar-card">
            <div class="drag-handle">‚ãÆ‚ãÆ</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--glass-border); flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <h3 style="margin: 0;">Calendar</h3>
                    <div class="calendar-month-year" style="display: flex; align-items: center; gap: 12px;">
                        <button type="button" id="calendar-prev" aria-label="Previous month" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer; font-size: 18px;">‚Äπ</button>
                        <span id="calendar-month-year" style="font-size: 20px; font-weight: 600; color: var(--text-primary); min-width: 180px; text-align: center;"></span>
                        <button type="button" id="calendar-next" aria-label="Next month" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer; font-size: 18px;">‚Ä∫</button>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label for="event-filter-type" style="color: var(--text-secondary); font-size: 14px;">Type:</label>
                        <select id="event-filter-type" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); font-size: 14px;">
                            <option value="">All</option>
                            <option value="shopping">Shopping</option>
                            <option value="appointment">Appointment</option>
                            <option value="birthday">Birthday</option>
                            <option value="meeting">Meeting</option>
                            <option value="reminder">Reminder</option>
                            <option value="travel">Travel</option>
                            <option value="event">Event</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label for="event-filter-user" style="color: var(--text-secondary); font-size: 14px;">User:</label>
                        <select id="event-filter-user" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); font-size: 14px;">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="calendar-view-btn" onclick="toggleCalendarView()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer; font-size: 14px;">List View</button>
                    </div>
                </div>
            </div>
            <div id="calendar" class="calendar-grid">
                <!-- Calendar will be generated here -->
            </div>
            <div id="calendar-list" class="calendar-list calendar-list-hidden">
                <!-- List view will be generated here -->
            </div>
        </div>
    </div>
</div>

<style>
.dashboard {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0px 24px;
    width: 100%;
}

.draggable-section {
    margin-bottom: 24px;
    position: relative;
    cursor: move;
}

.draggable-section.dragging {
    opacity: 0.5;
    border: 2px dashed var(--glass-border);
}

.drag-handle {
    position: absolute;
    top: 8px;
    right: 8px;
    cursor: grab;
    color: var(--text-secondary);
    font-size: 18px;
    opacity: 0.3;
    transition: opacity 0.3s ease;
    z-index: 10;
    user-select: none;
    pointer-events: auto;
    padding: 4px;
}

.draggable-section:hover .drag-handle {
    opacity: 0.8;
}

.dashboard-header {
    margin-bottom: 24px;
}

.header-card {
    padding: 24px;
}

.date-time {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.date-display {
    font-size: 18px;
    font-weight: 500;
    color: var(--text-secondary);
}

.time-display {
    font-size: 36px;
    font-weight: 700;
    color: var(--text-primary);
}

.weather {
    display: flex;
    align-items: center;
    gap: 16px;
}

#weather-icon {
    font-size: 56px;
}

#weather-info {
    text-align: left;
}

#weather-temp {
    font-size: 28px;
    font-weight: 700;
}

#weather-desc {
    font-size: 16px;
    color: var(--text-secondary);
}

.greeting-in-card {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid var(--glass-border);
}

.greeting-text {
    font-size: 22px;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
}

.quick-actions {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 12px;
    margin-bottom: 24px;
}

.quick-action-card {
    text-align: center;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quick-action-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-hover);
}

.action-icon {
    font-size: 28px;
    margin-bottom: 8px;
}

.quick-action-card h3 {
    margin: 0 0 4px 0;
    font-size: 14px;
    color: var(--text-primary);
}

.quick-action-card p {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
}

.magnets-section {
    margin-bottom: 24px;
}

.magnets-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

@media (max-width: 900px) {
    .magnets-grid {
        grid-template-columns: 1fr;
    }
}

.magnets-card {
    padding: 20px;
}

.magnets-card-standalone {
    position: relative;
}

.magnets-card-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

.magnets-column {
    position: relative;
}

.magnets-column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--glass-border);
}

.magnets-column-header h3 {
    margin: 0;
}

.btn-add-magnet {
    padding: 6px 14px;
    border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.15);
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-add-magnet:hover {
    background: rgba(255, 255, 255, 0.25);
}

.magnets-container {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.event-magnet {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.event-magnet:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-hover);
}

.event-magnet.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.calendar-section {
    margin-bottom: 24px;
}

.calendar-card {
    padding: 24px;
    width: 100%;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    width: 100%;
}

.calendar-day-header {
    text-align: center;
    padding: 16px;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 16px;
}

.calendar-day {
    min-height: 120px;
    padding: 12px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.calendar-day:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.02);
}

.calendar-day.today {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.calendar-day.drag-over {
    background: rgba(255, 255, 255, 0.2);
    border: 2px dashed var(--glass-border);
}

.calendar-day-number {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.calendar-day-events {
    font-size: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    position: relative;
    z-index: 2;
}

.calendar-event {
    background: rgba(255, 255, 255, 0.2);
    padding: 6px 8px;
    border-radius: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-primary);
    font-weight: 500;
    position: relative;
    z-index: 3;
}

.calendar-event.chore {
    background: rgba(74, 222, 128, 0.4);
    transition: all 0.2s ease;
}

.calendar-event.chore:hover {
    background: rgba(74, 222, 128, 0.6);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.calendar-event.event {
    background: rgba(59, 130, 246, 0.4);
}

.calendar-event.shopping {
    background: rgba(251, 191, 36, 0.4);
}

.calendar-event.appointment {
    background: rgba(168, 85, 247, 0.4);
}

.calendar-event.birthday {
    background: rgba(236, 72, 153, 0.4);
}

.calendar-event.meeting {
    background: rgba(34, 197, 94, 0.4);
}

.calendar-event.reminder {
    background: rgba(249, 115, 22, 0.4);
}

.calendar-event.travel {
    background: rgba(14, 165, 233, 0.4);
}

.calendar-event.chore.completed {
    text-decoration: line-through;
    opacity: 0.8;
}

.calendar-event.chore.pending_approval {
    background: rgba(251, 191, 36, 0.5);
    border-left-width: 4px;
    font-style: italic;
}

.calendar-event.chore.pending {
    background: rgba(251, 191, 36, 0.4);
}

.calendar-event.chore.skipped {
    background: rgba(156, 163, 175, 0.4);
    opacity: 0.6;
}

.calendar-event.recurring-trash {
    background: rgba(34, 197, 94, 0.5);
    font-weight: 600;
}

.calendar-event.recurring-trash.recycling {
    background: rgba(59, 130, 246, 0.5);
}

.calendar-event.recurring-parking {
    background: rgba(251, 191, 36, 0.5);
    font-weight: 600;
}

.parking-arrow {
    color: #ef4444;
    font-size: 20px;
    font-weight: bold;
    margin-left: 4px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.calendar-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 600px;
    overflow-y: auto;
}
.calendar-list-hidden {
    display: none !important;
}
.calendar-grid-hidden {
    display: none !important;
}

.calendar-list-item {
    padding: 12px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.calendar-list-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.calendar-list-item-date {
    font-weight: 600;
    color: var(--text-primary);
    min-width: 120px;
}

.calendar-list-item-content {
    flex: 1;
    margin-left: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.calendar-list-item-title {
    font-weight: 500;
    color: var(--text-primary);
}

.calendar-list-item-type {
    font-size: 12px;
    color: var(--text-secondary);
    padding: 4px 8px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    min-width: 400px;
    max-width: 500px;
    padding: 24px;
    border-radius: 16px;
}

.modal-content h3 {
    margin: 0 0 16px 0;
    color: var(--text-primary);
}

@media (max-width: 768px) {
    .quick-actions {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    .modal-content {
        min-width: 90%;
        margin: 20px;
    }
}
</style>

<script>
    (function() {
    const DASHBOARD_EL = document.getElementById('dashboard-container');
    const AUTHENTICATED = DASHBOARD_EL && DASHBOARD_EL.dataset.authenticated === 'true';
    const IS_ADMIN = DASHBOARD_EL && DASHBOARD_EL.dataset.admin === 'true';
    const CURRENT_USER_ID = DASHBOARD_EL && DASHBOARD_EL.dataset.userId ? parseInt(DASHBOARD_EL.dataset.userId, 10) : null;
    const CURRENT_USER_NAME = (DASHBOARD_EL && DASHBOARD_EL.dataset.userName) ? DASHBOARD_EL.dataset.userName : 'Guest';

    const today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    // Update date and time
    function updateDateTime() {
        const now = new Date();
        const dateStr = `${dayNames[now.getDay()]}, ${monthNames[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
        const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('current-date').textContent = dateStr;
        document.getElementById('current-time').textContent = timeStr;
    }
    
    // Update greeting based on time of day
    function updateGreeting() {
        const hour = new Date().getHours();
        let greeting = 'Good morning';
        if (hour >= 12 && hour < 17) {
            greeting = 'Good afternoon';
        } else if (hour >= 17) {
            greeting = 'Good evening';
        }
        document.getElementById('greeting').textContent = `${greeting}, ${CURRENT_USER_NAME}!`;
    }
    
    // Load weather from Open-Meteo (free, no API key)
    function weatherCodeToDesc(code) {
        const wmo = { 0: 'Clear', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast', 45: 'Foggy', 48: 'Foggy', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Dense drizzle', 61: 'Slight rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Slight snow', 73: 'Snow', 75: 'Heavy snow', 77: 'Snow grains', 80: 'Slight rain showers', 81: 'Rain showers', 82: 'Heavy rain showers', 85: 'Snow showers', 86: 'Heavy snow showers', 95: 'Thunderstorm', 96: 'Thunderstorm with hail', 99: 'Thunderstorm with heavy hail' };
        return wmo[code] || 'Unknown';
    }
    function weatherCodeToIcon(code) {
        if (code === 0) return '‚òÄÔ∏è'; if (code <= 3) return '‚õÖ'; if (code <= 48) return 'üå´Ô∏è';
        if (code <= 67) return 'üåßÔ∏è'; if (code <= 77) return '‚ùÑÔ∏è'; if (code <= 82) return 'üå¶Ô∏è';
        if (code <= 86) return 'üå®Ô∏è'; if (code <= 99) return '‚õàÔ∏è'; return 'üå°Ô∏è';
    }
    function loadWeather() {
        const setWeather = (temp, desc, icon) => {
            const te = document.getElementById('weather-temp'); if (te) te.textContent = temp;
            const de = document.getElementById('weather-desc'); if (de) de.textContent = desc;
            const ic = document.getElementById('weather-icon'); if (ic) ic.textContent = icon;
        };
        const fetchWeather = (lat, lon) => {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`;
            fetch(url).then(r => r.json()).then(data => {
                const c = data.current;
                if (c) {
                    const temp = Math.round(c.temperature_2m) + '¬∞F';
                    const desc = weatherCodeToDesc(c.weather_code);
                    const icon = weatherCodeToIcon(c.weather_code);
                    setWeather(temp, desc, icon);
                } else setWeather('--¬∞F', 'Unavailable', 'üå°Ô∏è');
            }).catch(() => setWeather('--¬∞F', 'Unavailable', 'üå°Ô∏è'));
        };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
                () => fetchWeather(40.7128, -74.0060),
                { timeout: 5000, maximumAge: 600000 }
            );
        } else fetchWeather(40.7128, -74.0060);
    }
    
    // Load upcoming tasks for authenticated users
    function loadUpcomingTasks() {
        if (!AUTHENTICATED) return;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        // Get chores assigned to current user
        fetch('/chores/api')
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(allChores => {
                const list = Array.isArray(allChores) ? allChores : [];
                const userChores = list.filter(c => c.assigned_user_id === CURRENT_USER_ID);
                
                // Get tracker entries for upcoming week
                fetch('/chores/tracker')
                    .then(r => { if (!r.ok) throw new Error(); return r.json(); })
                    .then(trackers => {
                        const list = Array.isArray(trackers) ? trackers : [];
                        const upcomingTrackers = list.filter(t => {
                            const trackerDate = new Date(t.date);
                            // Include pending and pending_approval, exclude only completed (approved) chores
                            const isCompletedAndApproved = t.status === 'completed' && t.approved_by_id;
                            return trackerDate >= today && trackerDate <= nextWeek && !isCompletedAndApproved;
                        });
                        
                        // Match trackers with chores
                        const upcomingTasks = upcomingTrackers
                            .map(t => {
                                const chore = userChores.find(c => c.id === t.chore_id);
                                return chore ? { ...t, chore } : null;
                            })
                            .filter(t => t !== null)
                            .sort((a, b) => new Date(a.date) - new Date(b.date))
                            .slice(0, 5);
                        
                        renderUpcomingTasks(upcomingTasks);
                    })
                    .catch(() => {
                        // If no trackers, recommend tasks based on day
                        recommendTasksByDay();
                    });
            })
            .catch(() => {
                recommendTasksByDay();
            });
    }
    
    function recommendTasksByDay() {
        const dayOfWeek = new Date().getDay();
        const recommendations = {
            0: ['Organize pantry', 'Plan meals for the week', 'Review shopping lists'],
            1: ['Clean bathrooms', 'Do laundry', 'Take out recycling'],
            2: ['Vacuum floors', 'Clean kitchen', 'Water plants'],
            3: ['Take out trash', 'Deep clean one room', 'Organize closets'],
            4: ['Mop floors', 'Clean windows', 'Declutter'],
            5: ['Weekend prep', 'Grocery shopping', 'Home maintenance'],
            6: ['Family time', 'Meal prep', 'Relax and recharge']
        };
        
        const tasks = recommendations[dayOfWeek] || ['Check calendar', 'Review chores', 'Plan ahead'];
        const container = document.getElementById('upcoming-tasks');
        if (container) {
            container.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px; font-weight: 600;">Recommended for today:</p>' +
                tasks.map(task => `<div style="padding: 6px 0; border-bottom: 1px solid var(--glass-border); color: var(--text-primary); font-size: 14px;">‚Ä¢ ${task}</div>`).join('');
        }
    }
    
    function renderUpcomingTasks(tasks) {
        const container = document.getElementById('upcoming-tasks');
        if (!container) return;
        
        if (tasks.length === 0) {
            recommendTasksByDay();
            return;
        }
        
        container.innerHTML = tasks.map(task => {
            const date = new Date(task.date);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            return `
                <div style="padding: 8px 0; border-bottom: 1px solid var(--glass-border);">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${dateStr}</div>
                    <div style="color: var(--text-primary); font-size: 14px; font-weight: 500;">${task.chore.task}</div>
                </div>
            `;
        }).join('');
    }
    
    // Load dashboard stats
    function loadStats() {
        function setCount(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }
        if (AUTHENTICATED) {
        fetch('/chores/api')
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => { setCount('pending-chores-count', Array.isArray(data) ? data.length : 0); })
            .catch(() => setCount('pending-chores-count', '0'));
        
        fetch('/items/api/low-stock')
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => { setCount('low-stock-count', Array.isArray(data) ? data.length : 0); })
            .catch(() => setCount('low-stock-count', '0'));
        
        fetch('/projects/api')
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => {
                const el = document.getElementById('active-projects-count');
                if (el) el.textContent = Array.isArray(data) ? data.length : 0;
            })
            .catch(() => setCount('active-projects-count', '0'));
        }
        
        fetch('/shopping-lists/api')
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => { setCount('shopping-lists-count', Array.isArray(data) ? data.length : 0); })
            .catch(() => setCount('shopping-lists-count', '0'));
        
        const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
        const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];
        fetch(`/events/api?start_date=${startDate}&end_date=${endDate}`)
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => { setCount('events-count', Array.isArray(data) ? data.length : 0); })
            .catch(() => setCount('events-count', '0'));
    }
    
    // Load calendar data
    let chores = [];
    let choreTrackers = [];
    let events = [];
    let draggedMagnet = null;
    let users = [];
    let rooms = [];
    let isListView = false;
    let eventFilterType = '';
    let eventFilterUser = '';
    
    function loadCalendarData() {
        // Load chores and trackers first, then events, then render
        const choresPromise = fetch('/chores/api?all=1')
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => {
                chores = Array.isArray(data) ? data : [];
                return loadChoreTracker();
            })
            .catch(() => {
                chores = [];
                return loadChoreTracker();
            });
        
        // Load users - available to all for display purposes
        const usersPromise = fetch('/users/api')
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => {
                users = Array.isArray(data) ? data : [];
                const userFilter = document.getElementById('event-filter-user');
                if (userFilter) {
                    userFilter.innerHTML = '<option value="">All</option>';
                    users.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.id;
                        option.textContent = u.name || u.username;
                        userFilter.appendChild(option);
                    });
                }
            })
            .catch(() => {
                users = [];
            });
        
        const roomsPromise = AUTHENTICATED
            ? fetch('/rooms/api')
                .then(r => { if (!r.ok) throw new Error(); return r.json(); })
                .then(data => { rooms = Array.isArray(data) ? data : []; })
                .catch(() => { rooms = []; })
            : Promise.resolve();
        
        // Load events for current month - available to all
        const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
        const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];
        const eventsPromise = fetch(`/events/api?start_date=${startDate}&end_date=${endDate}`)
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => {
                events = Array.isArray(data) ? data : [];
            })
            .catch(() => {
                events = [];
            });
        
        // Wait for all data to load, then render
        Promise.all([choresPromise, usersPromise, roomsPromise, eventsPromise])
            .then(() => {
                renderCalendar();
            })
            .catch(() => {
                renderCalendar();
            });
    }
    
    function loadChoreTracker() {
        return fetch('/chores/tracker')
            .then(r => {
                if (!r.ok) return [];
                return r.json();
            })
            .then(data => {
                choreTrackers = Array.isArray(data) ? data : [];
                return Promise.resolve();
            })
            .catch(() => {
                choreTrackers = [];
                return Promise.resolve();
            });
    }
    
    function getRecurringEvents(dateStr) {
        // Parse date string properly to avoid UTC timezone issues
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day); // month is 0-indexed
        const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const recurring = [];
        
        // Trash days
        if (dayOfWeek === 1) { // Monday - Recycling
            recurring.push({ type: 'trash', label: '‚ôªÔ∏è Recycling', class: 'recurring-trash recycling' });
        }
        if (dayOfWeek === 4) { // Thursday - Regular trash
            recurring.push({ type: 'trash', label: 'üóëÔ∏è Trash', class: 'recurring-trash regular' });
        }
        
        // Alternate side parking
        const now = new Date();
        const isToday = dateStr === `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const isParkingTime = isToday && currentHour >= 9 && (currentHour < 10 || (currentHour === 10 && currentMinute <= 30));
        
        if (dayOfWeek === 2 || dayOfWeek === 4) { // Tuesday & Thursday
            recurring.push({ 
                type: 'parking', 
                label: 'üöó Parking (T/Th)', 
                class: 'recurring-parking tue-thu',
                showArrow: isParkingTime
            });
        }
        if (dayOfWeek === 1 || dayOfWeek === 5) { // Monday & Friday
            recurring.push({ 
                type: 'parking', 
                label: 'üöó Parking (M/F)', 
                class: 'recurring-parking mon-fri',
                showArrow: isParkingTime
            });
        }
        
        return recurring;
    }
    
    function getEventType(event) {
        // Determine event type from title or use stored type
        if (event.event_type) return event.event_type;
        const title = event.title.toLowerCase();
        if (title.includes('shopping')) return 'shopping';
        if (title.includes('appointment')) return 'appointment';
        if (title.includes('birthday')) return 'birthday';
        if (title.includes('meeting')) return 'meeting';
        if (title.includes('reminder')) return 'reminder';
        if (title.includes('travel')) return 'travel';
        return 'event';
    }
    
    function filterEvents() {
        eventFilterType = document.getElementById('event-filter-type')?.value || '';
        eventFilterUser = document.getElementById('event-filter-user')?.value || '';
        if (isListView) {
            renderListView();
        } else {
            renderCalendar();
        }
    }
    
    function toggleCalendarView() {
        isListView = !isListView;
        const btn = document.getElementById('calendar-view-btn');
        const calendar = document.getElementById('calendar');
        const list = document.getElementById('calendar-list');
        if (!btn || !calendar || !list) return;
        if (isListView) {
            btn.textContent = 'Calendar View';
            calendar.classList.add('calendar-grid-hidden');
            list.classList.remove('calendar-list-hidden');
            renderListView();
        } else {
            btn.textContent = 'List View';
            calendar.classList.remove('calendar-grid-hidden');
            list.classList.add('calendar-list-hidden');
            renderCalendar();
        }
    }
    // Expose to global scope for onclick handler
    window.toggleCalendarView = toggleCalendarView;
    
    function renderListView() {
        const list = document.getElementById('calendar-list');
        list.innerHTML = '';
        
        // Combine all events and chores, sort by date
        const allItems = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Generate recurring events for the next 30 days
        const endDate = new Date(today);
        endDate.setDate(endDate.getDate() + 30);
        
        for (let d = new Date(today); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const recurring = getRecurringEvents(dateStr);
            
            recurring.forEach(r => {
                if (events.some(e => e.date === dateStr && getEventType(e) === r.type)) return;
                if (eventFilterType && r.type !== eventFilterType) return;
                
                allItems.push({
                    type: 'recurring',
                    date: dateStr,
                    title: r.label,
                    eventType: r.type,
                    class: r.class,
                    showArrow: r.showArrow
                });
            });
        }
        
        // Add events
        events.forEach(e => {
            const eventDate = new Date(e.date);
            if (eventDate >= today) {
                const eventType = getEventType(e);
                // Apply filters
                if (eventFilterType && eventType !== eventFilterType) return;
                if (eventFilterUser && e.user_id && parseInt(e.user_id) !== parseInt(eventFilterUser)) return;
                
                allItems.push({
                    type: 'event',
                    id: e.id,
                    date: e.date,
                    title: e.title,
                    eventType: eventType,
                    user_id: e.user_id,
                    time: e.time
                });
            }
        });
        
        // Add chores - filter out completed ones for today
        const todayStr = today.toISOString().split('T')[0];
        choreTrackers.forEach(ct => {
            const choreDate = new Date(ct.date);
            if (choreDate >= today) {
                // Include all chores including completed ones (they'll be shown with styling)
                
                const chore = chores.find(c => c.id === ct.chore_id);
                if (chore) {
                    // Apply user filter
                    if (eventFilterUser && chore.assigned_user_id && parseInt(chore.assigned_user_id) !== parseInt(eventFilterUser)) return;
                    
                    allItems.push({
                        type: 'chore',
                        id: ct.id,
                        chore_id: ct.chore_id,
                        date: ct.date,
                        title: chore.task,
                        status: ct.status || 'pending',
                        assigned_user_id: chore.assigned_user_id,
                        assigned_user_name: chore.assigned_user_name
                    });
                }
            }
        });
        
        // Sort by date
        allItems.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            return dateA - dateB;
        });
        
        // Render list items
        allItems.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'calendar-list-item';
            
            const date = new Date(item.date);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            const uid = item.user_id || item.assigned_user_id;
            const userInfo = uid ? (users.find(u => u.id === uid)?.name || 'Unknown') : '';
            const u = uid ? users.find(x => x.id === uid) : null;
            const borderColor = (u && u.color_code) ? u.color_code : 'transparent';
            
            // For recurring events, add arrow indicator if it's active parking time
            const arrowIndicator = item.showArrow ? ' <span class="parking-arrow">‚Üí</span>' : '';
            
            itemDiv.style.borderLeft = '4px solid ' + borderColor;
            itemDiv.innerHTML = `
                <div class="calendar-list-item-date">${dateStr}${item.time ? ' ' + item.time : ''}${arrowIndicator}</div>
                <div class="calendar-list-item-content">
                    <div class="calendar-list-item-title">${item.title}</div>
                    <div class="calendar-list-item-type ${item.class || ''}">${item.type === 'event' ? item.eventType : item.type === 'recurring' ? 'Recurring' : 'Chore'}</div>
                    ${userInfo ? `<div class="calendar-list-item-type">${userInfo}</div>` : ''}
                    ${item.status ? `<div class="calendar-list-item-type">${item.status}</div>` : ''}
                </div>
            `;
            
            itemDiv.style.cursor = 'pointer';
            if (item.type === 'recurring') {
                itemDiv.onclick = () => openRecurringTaskModal(item.title, item.eventType, item.date, null);
                itemDiv.title = 'View or mark done';
            } else if (item.type === 'event' && (item.eventType === 'parking' || item.eventType === 'trash')) {
                itemDiv.onclick = () => openRecurringTaskModal(item.title, item.eventType, item.date, item.id);
                itemDiv.title = 'Edit';
            } else {
                itemDiv.onclick = () => {
                    if (item.type === 'event') {
                        editEvent(item.id);
                    } else {
                        editChore(item.chore_id, item.id);
                    }
                };
            }
            
            list.appendChild(itemDiv);
        });
        
        if (allItems.length === 0) {
            list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No upcoming events or chores</div>';
        }
    }
    
    function updateCalendarMonthYear() {
        const el = document.getElementById('calendar-month-year');
        if (el) el.textContent = monthNames[currentMonth] + ' ' + currentYear;
    }
    
    function renderCalendar() {
        updateCalendarMonthYear();
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        
        // Add day headers
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = day;
            calendar.appendChild(header);
        });
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const todayDate = new Date();
        const isCurrentMonth = currentMonth === todayDate.getMonth() && currentYear === todayDate.getFullYear();
        
        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day';
            empty.style.opacity = '0.3';
            calendar.appendChild(empty);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = document.createElement('div');
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // Apply filters
            let dayEvents = events.filter(e => e.date === dateStr);
            if (eventFilterType) {
                dayEvents = dayEvents.filter(e => getEventType(e) === eventFilterType);
            }
            if (eventFilterUser) {
                dayEvents = dayEvents.filter(e => e.user_id && parseInt(e.user_id) === parseInt(eventFilterUser));
            }
            
            // Filter out chores that have been completed today
            const today = new Date().toISOString().split('T')[0];
            let dayChores = choreTrackers.filter(ct => {
                // Only show if it's for this date
                if (ct.date !== dateStr) return false;
                // Show all chores including completed ones (they'll be styled with line-through and user's color)
                return true;
            });
            if (eventFilterUser) {
                dayChores = dayChores.filter(ct => {
                    const chore = chores.find(c => c.id === ct.chore_id);
                    return chore && chore.assigned_user_id && parseInt(chore.assigned_user_id) === parseInt(eventFilterUser);
                });
            }
            
            const recurringEvents = getRecurringEvents(dateStr);
            const recurringToShow = recurringEvents.filter(r => !dayEvents.some(e => getEventType(e) === r.type));
            
            const isToday = isCurrentMonth && day === todayDate.getDate();
            
            dayDiv.className = 'calendar-day' + (isToday ? ' today' : '');
            dayDiv.dataset.date = dateStr;
            dayDiv.addEventListener('click', function(ev) {
                if (ev.target.closest('.calendar-event')) return;
                openAddForDayModal(dateStr);
            });
            
            dayDiv.innerHTML = `
                <div class="calendar-day-number">
                    ${day}
                    ${recurringToShow.filter(r => r.showArrow).map(r => `<span class="parking-arrow">‚Üí</span>`).join('')}
                </div>
                <div class="calendar-day-events">
                    ${recurringToShow.map(r => `<div class="calendar-event recurring-chip ${r.class}" data-recurring-label="${(r.label || '').replace(/"/g, '&quot;')}" data-recurring-type="${(r.type || '').replace(/"/g, '&quot;')}" data-recurring-date="${dateStr}" style="cursor: pointer;" title="View or mark done">${r.label}</div>`).join('')}
                    ${dayEvents.filter(e => { const t = getEventType(e); return t !== 'parking' && t !== 'trash'; }).map(e => {
                        const eventType = getEventType(e);
                        const u = e.user_id ? users.find(x => x.id === e.user_id) : null;
                        const borderColor = (u && u.color_code) ? u.color_code : 'transparent';
                        return `<div class="calendar-event ${eventType}" data-event-id="${e.id}" onclick="event.stopPropagation(); editEvent(${e.id})" style="cursor: pointer; border-left: 4px solid ${borderColor};">${e.title}</div>`;
                    }).join('')}
                    ${dayEvents.filter(e => { const t = getEventType(e); return t === 'parking' || t === 'trash'; }).map(e => {
                        const u = e.user_id ? users.find(x => x.id === e.user_id) : null;
                        const borderColor = (u && u.color_code) ? u.color_code : 'transparent';
                        const label = (e.title || '').replace(/"/g, '&quot;');
                        return `<div class="calendar-event recurring-chip recurring-completion ${getEventType(e)}" data-recurring-label="${label}" data-recurring-type="${e.event_type || getEventType(e)}" data-recurring-date="${dateStr}" data-event-id="${e.id}" style="cursor: pointer; border-left: 4px solid ${borderColor};" title="Edit">${e.title}</div>`;
                    }).join('')}
                    ${dayChores.map(ct => {
                        const status = ct.status || 'pending';
                        const chore = chores.find(c => c.id === ct.chore_id);
                        const task = chore ? chore.task : 'Chore';
                        const u = chore && chore.assigned_user_id ? users.find(x => x.id === chore.assigned_user_id) : null;
                        const borderColor = (u && u.color_code) ? u.color_code : 'transparent';
                        let style = `cursor: pointer; border-left: 4px solid ${borderColor};`;
                        if (status === 'completed' && u && u.color_code) {
                            // Use user's color for completed chores
                            const userColor = u.color_code.trim();
                            // Convert hex to rgba with opacity - handle both #RRGGBB and RRGGBB formats
                            let hex = userColor.startsWith('#') ? userColor.slice(1) : userColor;
                            if (hex.length === 6) {
                                const rgb = hex.match(/.{2}/g).map(x => parseInt(x, 16));
                                if (rgb && rgb.length === 3 && !rgb.some(isNaN)) {
                                    style += ` background: rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.4);`;
                                }
                            }
                        }
                        const statusText = status === 'pending_approval' ? ' (Pending Approval)' : '';
                        return `<div class="calendar-event chore ${status}" data-chore-id="${ct.chore_id}" data-tracker-id="${ct.id}" onclick="event.stopPropagation(); editChore(${ct.chore_id}, ${ct.id})" style="${style}" title="Click to view/edit chore details${statusText}">${task}${status === 'pending_approval' ? ' ‚è≥' : ''}</div>`;
                    }).join('')}
                </div>
            `;
            
            // Make calendar day a drop zone
            dayDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                dayDiv.classList.add('drag-over');
            });
            
            dayDiv.addEventListener('dragleave', () => {
                dayDiv.classList.remove('drag-over');
            });
            
            dayDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                dayDiv.classList.remove('drag-over');
                const date = dayDiv.dataset.date;
                let preselect = '';
                const payload = (e.dataTransfer && e.dataTransfer.getData('text/plain')) || '';
                if (payload.startsWith('event:')) {
                    // Extract event ID from payload (format: "event:123")
                    const eventIdStr = payload.replace(/^event:/i, '').trim();
                    const eventId = parseInt(eventIdStr);
                    if (!isNaN(eventId)) {
                        // Check if event exists
                        const ev = allEventsList.find(x => x.id === eventId);
                        if (ev) {
                            preselect = 'event:' + ev.id;
                        } else {
                            // Fallback: pass through as-is (for legacy format)
                            preselect = payload;
                        }
                    } else {
                        // Legacy format: pass through as-is
                        preselect = payload;
                    }
                } else if (payload.startsWith('chore:')) {
                    // Extract chore ID from payload (format: "chore:123")
                    const choreIdStr = payload.replace(/^chore:/i, '').trim();
                    const choreId = parseInt(choreIdStr);
                    if (!isNaN(choreId)) {
                        // Check if chore exists
                        const c = chores.find(x => x.id === choreId);
                        if (c) {
                            preselect = 'chore:' + c.id;
                        } else {
                            // Fallback: try to match by task name (for backward compatibility)
                            const choreTask = choreIdStr.toLowerCase();
                            const c = chores.find(function(x) {
                                const t = (x.task || '').trim().toLowerCase();
                                return t === choreTask || t.indexOf(choreTask) === 0 || choreTask.indexOf(t) === 0;
                            });
                            if (c) preselect = 'chore:' + c.id;
                        }
                    }
                }
                if (draggedMagnet) draggedMagnet = null;
                openAddForDayModal(date, preselect);
            });
            
            calendar.appendChild(dayDiv);
        }
    }
    
    function createEventWithNote(title, date, eventType, description) {
        if (!AUTHENTICATED) return;
        fetch('/events/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                date: date,
                event_type: eventType || 'event',
                description: description || 'Marked done from recurring task'
            })
        })
        .then(r => {
            if (r.ok) return r.json();
            throw new Error('Failed to create event');
        })
        .then(data => {
            events.push(data);
            renderCalendar();
        })
        .catch(err => {
            console.error('Error creating event:', err);
            alert('Failed to save. Please try again.');
        });
    }
    
    function updateEventWithNote(eventId, title, date, eventType, description) {
        if (!AUTHENTICATED) return;
        fetch('/events/api/' + eventId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                date: date,
                event_type: eventType || 'event',
                description: description || ''
            })
        })
        .then(r => {
            if (r.ok) return r.json();
            throw new Error('Failed to update event');
        })
        .then(data => {
            const idx = events.findIndex(e => e.id === eventId);
            if (idx !== -1) events[idx] = data;
            renderCalendar();
        })
        .catch(err => {
            console.error('Error updating event:', err);
            alert('Failed to save. Please try again.');
        });
    }
    
    function deleteRecurringEvent(eventId) {
        if (!AUTHENTICATED) return;
        fetch('/events/api/' + eventId, { method: 'DELETE' })
        .then(r => {
            if (r.ok) {
                events = events.filter(e => e.id !== eventId);
                renderCalendar();
            } else throw new Error('Failed to delete');
        })
        .catch(err => {
            console.error('Error deleting event:', err);
            alert('Failed to delete.');
        });
    }
    
    function createEvent(title, date, eventType = null, showEdit = false) {
        if (AUTHENTICATED) {
        fetch('/events/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                date: date,
                event_type: eventType,
                description: `Quick event created from dashboard`
            })
        })
        .then(r => {
            if (r.ok) {
                return r.json();
            }
            throw new Error('Failed to create event');
        })
        .then(data => {
            events.push(data);
            renderCalendar();
            if (showEdit) {
                // Show edit popup after a short delay to ensure calendar is rendered
                setTimeout(() => editEvent(data.id), 100);
            }
        })
        .catch(err => {
            console.error('Error creating event:', err);
            alert('Failed to create event. Please try again.');
        });
        } else {
        showPasswordPrompt(title, date);
        }
    }
    
    function createChore(task, date, icon, showEdit = false) {
        if (AUTHENTICATED) {
        fetch('/chores/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                task: task,
                frequency: 'once',
                assigned_user_id: CURRENT_USER_ID,
                reward: 0,
                room_id: null
            })
        })
        .then(r => {
            if (r.ok) {
                return r.json();
            }
            throw new Error('Failed to create chore');
        })
        .then(choreData => {
            // Create tracker entry for the date
            return fetch('/chores/tracker', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chore_id: choreData.id,
                    date: date,
                    status: 'pending'
                })
            })
            .then(r => {
                if (r.ok) {
                    return r.json();
                }
                throw new Error('Failed to create chore tracker');
            })
            .then(trackerData => {
                chores.push(choreData);
                choreTrackers.push(trackerData);
                renderCalendar();
                if (showEdit) {
                    setTimeout(() => editChore(choreData.id, trackerData.id), 100);
                }
            });
        })
        .catch(err => {
            console.error('Error creating chore:', err);
            alert('Failed to create chore. Please try again.');
        });
        } else {
        alert('Please log in to create chores');
        }
    }
    
    function openRecurringTaskModal(label, type, dateStr, existingEventId) {
        if (!AUTHENTICATED) {
            alert('Please log in to mark recurring tasks done.');
            return;
        }
        let modal = document.getElementById('recurring-task-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'recurring-task-modal';
            modal.className = 'modal-overlay';
            modal.style.display = 'none';
            modal.innerHTML = `
                <div class="modal-content glass-card" onclick="event.stopPropagation()" style="background: var(--glass-bg); border: 1px solid var(--glass-border); min-width: 380px;">
                    <h3 style="margin: 0 0 4px 0; color: var(--text-primary); font-size: 16px;">Recurring task</h3>
                    <p id="recurring-task-date" style="color: var(--text-secondary); margin: 0 0 20px 0; font-size: 14px;"></p>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-primary); font-size: 14px;">Title</label>
                        <input type="text" id="recurring-task-title" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-primary); font-size: 14px;">Note (optional)</label>
                        <textarea id="recurring-task-note" rows="3" placeholder="Add a note..." style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button type="button" id="recurring-task-cancel" style="padding: 10px 18px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.15); color: var(--text-primary); cursor: pointer; font-size: 14px;">Cancel</button>
                        <button type="button" id="recurring-task-delete-or-save" style="padding: 10px 18px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(239, 68, 68, 0.8); color: white; cursor: pointer; font-size: 14px;">Delete / Skip</button>
                        <button type="button" id="recurring-task-done" style="padding: 10px 18px; border-radius: 8px; border: none; background: rgba(34, 197, 94, 0.9); color: white; cursor: pointer; font-weight: 600; font-size: 14px;">Mark done</button>
                    </div>
                </div>
            `;
            modal.onclick = function(e) { if (e.target === modal) closeRecurringTaskModal(); };
            document.body.appendChild(modal);
            document.getElementById('recurring-task-cancel').onclick = closeRecurringTaskModal;
            var deleteOrSaveBtn = document.getElementById('recurring-task-delete-or-save');
            deleteOrSaveBtn.onclick = function() {
                var m = document.getElementById('recurring-task-modal');
                var eid = m && m.dataset.eventId ? parseInt(m.dataset.eventId, 10) : null;
                closeRecurringTaskModal();
                if (eid) deleteRecurringEvent(eid);
            };
            document.getElementById('recurring-task-done').onclick = function() {
                var m = document.getElementById('recurring-task-modal');
                var titleInput = document.getElementById('recurring-task-title');
                var noteInput = document.getElementById('recurring-task-note');
                var title = (titleInput && titleInput.value.trim()) ? titleInput.value.trim() : (m.dataset.label || 'Recurring task');
                var taskType = m.dataset.type || 'event';
                var description = (noteInput && noteInput.value.trim()) ? noteInput.value.trim() : null;
                var eid = m.dataset.eventId ? parseInt(m.dataset.eventId, 10) : null;
                closeRecurringTaskModal();
                if (eid) updateEventWithNote(eid, title, m.dataset.date, taskType, description);
                else createEventWithNote(title, m.dataset.date, taskType, description);
            };
            function updateRecurringDeleteOrSaveButton() {
                var m = document.getElementById('recurring-task-modal');
                if (!m) return;
                var titleInput = document.getElementById('recurring-task-title');
                var noteInput = document.getElementById('recurring-task-note');
                var initialTitle = m.dataset.initialTitle || '';
                var initialNote = m.dataset.initialNote || '';
                var currentTitle = (titleInput && titleInput.value) ? titleInput.value : '';
                var currentNote = (noteInput && noteInput.value) ? noteInput.value : '';
                var hasChanges = (currentTitle.trim() !== initialTitle.trim()) || (currentNote.trim() !== initialNote.trim());
                var btn = document.getElementById('recurring-task-delete-or-save');
                if (!btn) return;
                if (hasChanges) {
                    btn.textContent = 'Save changes';
                    btn.style.background = 'rgba(59, 130, 246, 0.9)';
                    btn.style.border = 'none';
                    btn.onclick = function() {
                        var modal = document.getElementById('recurring-task-modal');
                        var ti = document.getElementById('recurring-task-title');
                        var ni = document.getElementById('recurring-task-note');
                        var t = (ti && ti.value.trim()) ? ti.value.trim() : (modal.dataset.label || 'Recurring task');
                        var desc = (ni && ni.value.trim()) ? ni.value.trim() : null;
                        var eid = modal.dataset.eventId ? parseInt(modal.dataset.eventId, 10) : null;
                        closeRecurringTaskModal();
                        if (eid) updateEventWithNote(eid, t, modal.dataset.date, modal.dataset.type || 'event', desc);
                        else createEventWithNote(t, modal.dataset.date, modal.dataset.type || 'event', desc);
                    };
                } else {
                    btn.textContent = m.dataset.eventId ? 'Delete' : 'Delete / Skip';
                    btn.style.background = 'rgba(239, 68, 68, 0.8)';
                    btn.style.border = '1px solid var(--glass-border)';
                    btn.onclick = function() {
                        var eid = m.dataset.eventId ? parseInt(m.dataset.eventId, 10) : null;
                        closeRecurringTaskModal();
                        if (eid) deleteRecurringEvent(eid);
                    };
                }
            }
            document.getElementById('recurring-task-title').addEventListener('input', updateRecurringDeleteOrSaveButton);
            document.getElementById('recurring-task-title').addEventListener('change', updateRecurringDeleteOrSaveButton);
            document.getElementById('recurring-task-note').addEventListener('input', updateRecurringDeleteOrSaveButton);
            document.getElementById('recurring-task-note').addEventListener('change', updateRecurringDeleteOrSaveButton);
        }
        modal.dataset.date = dateStr;
        modal.dataset.label = label;
        modal.dataset.type = type || 'event';
        if (existingEventId) modal.dataset.eventId = String(existingEventId);
        else delete modal.dataset.eventId;
        const existingEvent = existingEventId ? events.find(function(e) { return e.id === existingEventId; }) : null;
        const initialTitle = existingEvent ? (existingEvent.title || label) : label;
        const initialNote = existingEvent ? (existingEvent.description || '') : '';
        modal.dataset.initialTitle = initialTitle;
        modal.dataset.initialNote = initialNote;
        const titleEl = document.getElementById('recurring-task-title');
        const noteEl = document.getElementById('recurring-task-note');
        if (titleEl) { titleEl.value = initialTitle; }
        if (noteEl) { noteEl.value = initialNote; }
        const dateEl = document.getElementById('recurring-task-date');
        if (dateEl) {
            const d = new Date(dateStr + 'T12:00:00');
            dateEl.textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        }
        var deleteOrSaveBtn = document.getElementById('recurring-task-delete-or-save');
        if (deleteOrSaveBtn) {
            deleteOrSaveBtn.textContent = existingEventId ? 'Delete' : 'Delete / Skip';
            deleteOrSaveBtn.style.background = 'rgba(239, 68, 68, 0.8)';
            deleteOrSaveBtn.style.border = '1px solid var(--glass-border)';
            deleteOrSaveBtn.onclick = function() {
                var eid = modal.dataset.eventId ? parseInt(modal.dataset.eventId, 10) : null;
                closeRecurringTaskModal();
                if (eid) deleteRecurringEvent(eid);
            };
        }
        modal.style.display = 'flex';
    }
    
    function closeRecurringTaskModal() {
        const m = document.getElementById('recurring-task-modal');
        if (m) m.style.display = 'none';
    }
    
    function openAddForDayModal(dateStr, preselectValue) {
        if (!AUTHENTICATED) {
            alert('Please log in to add events or chores.');
            return;
        }
        let modal = document.getElementById('add-for-day-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'add-for-day-modal';
            modal.className = 'modal-overlay';
            modal.style.display = 'none';
            modal.innerHTML = `
                <div class="modal-content glass-card" onclick="event.stopPropagation()">
                    <h3>Add for this day</h3>
                    <p id="add-for-day-date-display" style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;"></p>
                    <p style="color: var(--text-secondary); margin-bottom: 8px;">What needs to be completed?</p>
                    <select id="add-for-day-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); margin-bottom: 12px;">
                        <option value="">-- Select --</option>
                        <optgroup label="Events" id="add-for-day-events"></optgroup>
                        <optgroup label="Chores" id="add-for-day-chores"></optgroup>
                    </select>
                    <div id="add-for-day-user-wrap" style="margin-bottom: 12px; display: none;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Assign to</label>
                        <select id="add-for-day-user" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                    <div id="add-for-day-room-wrap" style="margin-bottom: 12px; display: none;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Room</label>
                        <select id="add-for-day-room" disabled style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text-primary); opacity: 0.7;">
                            <option value="">-- Select Room --</option>
                        </select>
                    </div>
                    <div id="add-for-day-due-by-wrap" style="margin-bottom: 20px; display: none;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Due by (optional; late = 2 tokens/day)</label>
                        <input type="date" id="add-for-day-due-by" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary);">
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" id="add-for-day-cancel" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer;">Cancel</button>
                        <button type="button" id="add-for-day-add" style="padding: 10px 20px; border-radius: 8px; border: none; background: rgba(59, 130, 246, 0.8); color: white; cursor: pointer; font-weight: 600;">Add</button>
                    </div>
                </div>
            `;
            modal.onclick = function(e) { if (e.target === modal) closeAddForDayModal(); };
            document.body.appendChild(modal);
            document.getElementById('add-for-day-cancel').onclick = closeAddForDayModal;
            document.getElementById('add-for-day-add').onclick = function() {
                const sel = document.getElementById('add-for-day-select');
                const val = sel.value;
                if (!val) { alert('Please select an option.'); return; }
                const date = document.getElementById('add-for-day-modal').dataset.date;
                const parts = val.split(':');
                if (parts[0] === 'event') {
                    const eventId = parseInt(parts[1]);
                    if (!isNaN(eventId)) {
                        // Event ID format: event:ID
                        const event = allEventsList.find(e => e.id === eventId);
                        if (event) {
                            closeAddForDayModal();
                            createEvent(event.title, date, event.event_type || 'event', true);
                        } else {
                            alert('Event not found.');
                        }
                    } else {
                        // Legacy format: event:type:title
                        const eventType = parts[1];
                        const title = parts[2] || 'Event';
                        closeAddForDayModal();
                        createEvent(title, date, eventType, true);
                    }
                } else if (parts[0] === 'chore') {
                    const choreId = parseInt(parts[1]);
                    const chore = chores.find(c => c.id === choreId);
                    if (chore) {
                        const dueByEl = document.getElementById('add-for-day-due-by');
                        const dueBy = dueByEl && dueByEl.value ? dueByEl.value : null;
                        const userEl = document.getElementById('add-for-day-user');
                        const assignedUserId = userEl && userEl.value ? parseInt(userEl.value) : null;
                        
                        // First, update the chore's assigned user if changed
                        let updatePromise = Promise.resolve();
                        if (assignedUserId !== chore.assigned_user_id) {
                            updatePromise = fetch(`/chores/api/${choreId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ assigned_user_id: assignedUserId })
                            }).then(r => {
                                if (!r.ok) throw new Error('Failed to update chore assignment');
                                return r.json();
                            });
                        }
                        
                        // Then create the tracker entry
                        updatePromise.then(() => {
                            return fetch('/chores/tracker', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    chore_id: choreId, 
                                    date: date, 
                                    status: 'pending', 
                                    due_by_date: dueBy
                                })
                            });
                        })
                        .then(r => r.ok ? r.json() : Promise.reject())
                        .then(trackerData => {
                            // Reload chores to get updated assignment
                            return fetch('/chores/api?all=1')
                                .then(r => r.ok ? r.json() : [])
                                .then(data => {
                                    chores = Array.isArray(data) ? data : [];
                                    choreTrackers.push(trackerData);
                                    renderCalendar();
                                    closeAddForDayModal();
                                });
                        })
                        .catch((err) => {
                            console.error('Error adding chore:', err);
                            alert('Failed to add chore to this day.');
                        });
                    }
                }
            };
        }
        const eventsGroup = document.getElementById('add-for-day-events');
        if (eventsGroup) {
            eventsGroup.innerHTML = '';
            allEventsList.forEach(e => {
                const opt = document.createElement('option');
                opt.value = 'event:' + e.id;
                const icon = extractEmoji(e.title);
                opt.textContent = icon + ' ' + (e.title || ('Event #' + e.id));
                eventsGroup.appendChild(opt);
            });
        }
        
        const choresGroup = document.getElementById('add-for-day-chores');
        if (choresGroup) {
            choresGroup.innerHTML = '';
            chores.forEach(c => {
                const opt = document.createElement('option');
                opt.value = 'chore:' + c.id;
                opt.textContent = c.task || ('Chore #' + c.id);
                choresGroup.appendChild(opt);
            });
        }
        modal.dataset.date = dateStr;
        
        // Get references to user, room and due date elements
        const userWrap = document.getElementById('add-for-day-user-wrap');
        const userSelect = document.getElementById('add-for-day-user');
        const roomWrap = document.getElementById('add-for-day-room-wrap');
        const roomSelect = document.getElementById('add-for-day-room');
        const dueByInput = document.getElementById('add-for-day-due-by');
        const dueByWrap = document.getElementById('add-for-day-due-by-wrap');
        
        // Populate user dropdown
        if (userSelect) {
            userSelect.innerHTML = '<option value="">Unassigned</option>';
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = u.name || u.username;
                userSelect.appendChild(opt);
            });
        }
        
        // Initialize fields - will be updated by updateChoreFields function below
        if (userWrap) userWrap.style.display = 'none';
        if (roomWrap) roomWrap.style.display = 'none';
        if (dueByWrap) dueByWrap.style.display = 'none';
        
        // Function to update user/room/due date visibility based on selected chore
        function updateChoreFields(selectedChoreId) {
            const userWrapEl = document.getElementById('add-for-day-user-wrap');
            const userSelectEl = document.getElementById('add-for-day-user');
            const roomWrapEl = document.getElementById('add-for-day-room-wrap');
            const roomSelectEl = document.getElementById('add-for-day-room');
            const dueByInputEl = document.getElementById('add-for-day-due-by');
            const dueByWrapEl = document.getElementById('add-for-day-due-by-wrap');
            
            if (selectedChoreId && selectedChoreId.startsWith('chore:')) {
                const choreId = parseInt(selectedChoreId.replace(/^chore:/, ''));
                const chore = chores.find(c => c.id === choreId);
                
                if (!chore) {
                    console.warn('Chore not found:', choreId);
                    return;
                }
                
                // Show user dropdown
                if (userWrapEl && userSelectEl) {
                    // Set to chore's assigned user if it has one, otherwise leave as "Unassigned"
                    if (chore.assigned_user_id) {
                        userSelectEl.value = chore.assigned_user_id;
                    } else {
                        userSelectEl.value = '';
                    }
                    userWrapEl.style.display = 'block';
                }
                
                // Show room dropdown if chore has a room
                if (roomWrapEl && roomSelectEl) {
                    if (chore.room_id) {
                        // Show room dropdown with only the chore's room
                        roomSelectEl.innerHTML = '<option value="">-- Select Room --</option>';
                        const choreRoom = rooms.find(r => r.id === chore.room_id);
                        if (choreRoom) {
                            const opt = document.createElement('option');
                            opt.value = choreRoom.id;
                            opt.textContent = choreRoom.name || 'Room';
                            opt.selected = true;
                            roomSelectEl.appendChild(opt);
                        } else {
                            // Room not found in rooms array, but chore has room_id
                            const opt = document.createElement('option');
                            opt.value = chore.room_id;
                            opt.textContent = chore.room_name || 'Room';
                            opt.selected = true;
                            roomSelectEl.appendChild(opt);
                        }
                        roomSelectEl.disabled = true; // Read-only since it's from the chore
                        roomWrapEl.style.display = 'block';
                    } else {
                        roomWrapEl.style.display = 'none';
                    }
                }
                
                // Show due date field
                if (dueByWrapEl && dueByInputEl) {
                    if (!dueByInputEl.value) {
                        dueByInputEl.value = dateStr;
                    }
                    dueByWrapEl.style.display = 'block';
                }
            } else {
                if (userWrapEl) userWrapEl.style.display = 'none';
                if (roomWrapEl) roomWrapEl.style.display = 'none';
                if (dueByWrapEl) dueByWrapEl.style.display = 'none';
            }
        }
        
        const selectEl = document.getElementById('add-for-day-select');
        if (selectEl) {
            // Remove old event listeners by cloning and replacing
            const newSelectEl = selectEl.cloneNode(true);
            selectEl.parentNode.replaceChild(newSelectEl, selectEl);
            
            // Set preselected value and update fields
            if (preselectValue) {
                newSelectEl.value = preselectValue;
                // Update fields immediately if chore is preselected
                if (preselectValue.startsWith('chore:')) {
                    // Call immediately
                    updateChoreFields(preselectValue);
                    // Also call after a short delay to ensure everything is set
                    setTimeout(function() { 
                        updateChoreFields(preselectValue);
                    }, 50);
                }
            } else {
                newSelectEl.value = '';
            }
            
            // Update user/room/due date visibility when selection changes
            newSelectEl.addEventListener('change', function() {
                updateChoreFields(this.value);
            });
        }
        var dateDisplay = document.getElementById('add-for-day-date-display');
        if (dateDisplay) {
            var d = new Date(dateStr + 'T12:00:00');
            dateDisplay.textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        }
        modal.style.display = 'flex';
    }
    
    function closeAddForDayModal() {
        const m = document.getElementById('add-for-day-modal');
        if (m) m.style.display = 'none';
    }
    
    function editEvent(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;
        
        showEventEditModal(event);
    }
    // Expose to global scope for onclick handlers
    window.editEvent = editEvent;
    
    function editChore(choreId, trackerId) {
        const chore = chores.find(c => c.id === choreId);
        const tracker = choreTrackers.find(ct => ct.id === trackerId);
        if (!chore) return;
        
        showChoreEditModal(chore, tracker);
    }
    // Expose to global scope for onclick handlers
    window.editChore = editChore;
    
    function showEventEditModal(event) {
        const modal = document.getElementById('edit-event-modal');
        if (!modal) {
            const modalHTML = `
                <div id="edit-event-modal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeEventModal()">
                    <div class="modal-content glass-card" onclick="event.stopPropagation()">
                        <h3>Edit Event</h3>
                        <form id="event-edit-form" onsubmit="saveEvent(event)">
                            <input type="hidden" id="event-edit-id">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Title</label>
                                <input type="text" id="event-edit-title" required 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Type</label>
                                <select id="event-edit-type" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary);">
                                    <option value="">Event</option>
                                    <option value="shopping">Shopping</option>
                                    <option value="appointment">Appointment</option>
                                    <option value="birthday">Birthday</option>
                                    <option value="meeting">Meeting</option>
                                    <option value="reminder">Reminder</option>
                                    <option value="travel">Travel</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Date</label>
                                <input type="date" id="event-edit-date" required 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Time (optional)</label>
                                <input type="time" id="event-edit-time" 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Description</label>
                                <textarea id="event-edit-description" rows="3"
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary); resize: vertical;"></textarea>
                            </div>
                            <p id="event-edit-updated" style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-secondary);"></p>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" id="event-edit-delete-btn" onclick="deleteEvent()" 
                                        style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                               background: rgba(239, 68, 68, 0.8); color: white; cursor: pointer;">
                                    Delete
                                </button>
                                <button type="button" id="event-edit-close-btn" onclick="closeEventModal()" 
                                        style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                               background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer;">
                                    Close
                                </button>
                                <button type="submit" id="event-edit-save-btn" 
                                        style="padding: 10px 20px; border-radius: 8px; border: none; 
                                               background: rgba(59, 130, 246, 0.8); color: white; cursor: pointer; font-weight: 600; display: none;">
                                    Save
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        document.getElementById('event-edit-id').value = event.id;
        document.getElementById('event-edit-title').value = event.title || '';
        document.getElementById('event-edit-date').value = event.date || '';
        document.getElementById('event-edit-time').value = event.time || '';
        document.getElementById('event-edit-description').value = event.description || '';
        const typeSelect = document.getElementById('event-edit-type');
        if (typeSelect) typeSelect.value = event.event_type || '';
        const updatedEl = document.getElementById('event-edit-updated');
        if (updatedEl) {
            if (event.updated_by_name && event.updated_at) {
                const d = new Date(event.updated_at);
                updatedEl.textContent = 'Last updated by ' + event.updated_by_name + ' on ' + d.toLocaleDateString() + ' at ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                updatedEl.style.display = 'block';
            } else {
                updatedEl.textContent = '';
                updatedEl.style.display = 'none';
            }
        }
        
        // Store original values for change detection
        const originalValues = {
            title: event.title || '',
            event_type: event.event_type || '',
            date: event.date || '',
            time: event.time || '',
            description: event.description || ''
        };
        modal.dataset.originalValues = JSON.stringify(originalValues);
        
        // Function to check if form has changes
        function checkForChanges() {
            if (!AUTHENTICATED) return false;
            
            const currentTitle = document.getElementById('event-edit-title').value;
            const currentType = document.getElementById('event-edit-type').value || '';
            const currentDate = document.getElementById('event-edit-date').value || '';
            const currentTime = document.getElementById('event-edit-time').value || '';
            const currentDescription = document.getElementById('event-edit-description').value || '';
            
            const hasChanges = 
                currentTitle !== originalValues.title ||
                currentType !== originalValues.event_type ||
                currentDate !== originalValues.date ||
                currentTime !== originalValues.time ||
                currentDescription !== originalValues.description;
            
            const saveBtn = document.getElementById('event-edit-save-btn');
            const closeBtn = document.getElementById('event-edit-close-btn');
            
            if (saveBtn && closeBtn) {
                if (hasChanges) {
                    saveBtn.style.display = '';
                    closeBtn.style.display = 'none';
                } else {
                    saveBtn.style.display = 'none';
                    closeBtn.style.display = '';
                }
            }
            
            return hasChanges;
        }
        
        // Add change listeners to all form fields
        const form = document.getElementById('event-edit-form');
        const formFields = form.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            field.addEventListener('change', checkForChanges);
            field.addEventListener('input', checkForChanges);
        });
        
        // Initial check
        checkForChanges();
        
        const deleteBtn = document.getElementById('event-edit-delete-btn');
        const saveBtn = document.getElementById('event-edit-save-btn');
        const closeBtn = document.getElementById('event-edit-close-btn');
        if (deleteBtn) deleteBtn.style.display = AUTHENTICATED ? '' : 'none';
        if (saveBtn) saveBtn.style.display = AUTHENTICATED ? 'none' : 'none'; // Will be shown by checkForChanges
        if (closeBtn) closeBtn.style.display = AUTHENTICATED ? '' : 'none';
        document.getElementById('edit-event-modal').style.display = 'flex';
    }
    
    function showChoreEditModal(chore, tracker) {
        const modal = document.getElementById('edit-chore-modal');
        if (!modal) {
            const modalHTML = `
                <div id="edit-chore-modal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeChoreModal()">
                    <div class="modal-content glass-card" onclick="event.stopPropagation()">
                        <h3>Edit Chore</h3>
                        <form id="chore-edit-form" onsubmit="saveChore(event)">
                            <input type="hidden" id="chore-edit-id">
                            <input type="hidden" id="chore-tracker-id">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Task</label>
                                <input type="text" id="chore-edit-task" required 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 12px; color: var(--text-primary);">Assigned To</label>
                                <div id="chore-edit-user-radio" style="display: flex; flex-wrap: wrap; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s ease;" class="user-radio-option">
                                        <input type="radio" name="chore-assigned-user" value="" style="margin: 0;">
                                        <span>Unassigned</span>
                                    </label>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Room</label>
                                <select id="chore-edit-room" 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                                    <option value="">No Room</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Tokens</label>
                                <input type="number" id="chore-edit-reward" step="1" min="0" value="0"
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Due by</label>
                                <input type="date" id="chore-edit-due-by"
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                                <p style="margin: 4px 0 0; font-size: 12px; color: var(--text-secondary);">Late = 2 tokens/day</p>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Status</label>
                                <select id="chore-edit-status" 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                                    <option value="pending">Pending</option>
                                    <option value="pending_approval">Pending Approval</option>
                                    <option value="completed">Completed</option>
                                    <option value="skipped">Skipped</option>
                                </select>
                            </div>
                            <div id="chore-assigner-notes-section" style="margin-bottom: 20px; display: none;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Assigner Notes</label>
                                <textarea id="chore-assigner-notes" rows="3" readonly
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.05); color: var(--text-secondary); resize: vertical;"></textarea>
                            </div>
                            <div id="chore-approval-actions" style="margin-bottom: 20px; display: none;">
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" id="chore-approve-btn" onclick="approveChoreCompletion()" 
                                            style="flex: 1; padding: 10px 20px; border-radius: 8px; border: none; 
                                                   background: rgba(34, 197, 94, 0.8); color: white; cursor: pointer; font-weight: 600;">
                                        Approve Completion
                                    </button>
                                    <button type="button" id="chore-reinstate-btn" onclick="openReinstateModal()" 
                                            style="flex: 1; padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                                   background: rgba(251, 191, 36, 0.8); color: white; cursor: pointer; font-weight: 600;">
                                        Reinstate with Notes
                                    </button>
                                </div>
                            </div>
                            <p id="chore-edit-updated" style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-secondary);"></p>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" id="chore-edit-delete-btn" onclick="deleteChore()" 
                                        style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                               background: rgba(239, 68, 68, 0.8); color: white; cursor: pointer;">
                                    Delete
                                </button>
                                <button type="button" id="chore-edit-close-btn" onclick="closeChoreModal()" 
                                        style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                               background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer;">
                                    Close
                                </button>
                                <button type="submit" id="chore-edit-save-btn" 
                                        style="padding: 10px 20px; border-radius: 8px; border: none; 
                                               background: rgba(59, 130, 246, 0.8); color: white; cursor: pointer; font-weight: 600; display: none;">
                                    Save
                                </button>
                                <button type="button" id="chore-edit-save-login-btn" onclick="alert('Please log in to save changes')" 
                                        style="padding: 10px 20px; border-radius: 8px; border: none; 
                                               background: rgba(59, 130, 246, 0.8); color: white; cursor: pointer; font-weight: 600;">
                                    Save (Login Required)
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Populate user radio buttons - restrict to self if not admin
        const userRadioContainer = document.getElementById('chore-edit-user-radio');
        const unassignedLabel = userRadioContainer.querySelector('label');
        userRadioContainer.innerHTML = '';
        userRadioContainer.appendChild(unassignedLabel);
        
        const isAdmin = IS_ADMIN;
        const currentUserId = CURRENT_USER_ID;
        const isAuthenticated = AUTHENTICATED;
        
        users.forEach(u => {
            // Only show current user in radio buttons if not admin, or show all if admin
            if (!isAdmin && u.id !== currentUserId) return;
            
            const label = document.createElement('label');
            label.className = 'user-radio-option';
            label.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s ease;';
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'chore-assigned-user';
            radio.value = u.id;
            radio.style.margin = '0';
            if (chore.assigned_user_id === u.id) radio.checked = true;
            
            // Disable if not authenticated or not admin and chore is assigned to someone else
            if (!isAuthenticated || (!isAdmin && chore.assigned_user_id && chore.assigned_user_id !== currentUserId)) {
                radio.disabled = true;
                label.style.opacity = '0.5';
                label.style.cursor = 'not-allowed';
            }
            
            const img = document.createElement('img');
            img.src = u.profile_image ? `/static/uploads/${u.profile_image}` : '';
            img.alt = u.name || u.username;
            img.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--glass-border);';
            img.onerror = function() {
                this.style.display = 'none';
                const placeholder = document.createElement('div');
                placeholder.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 18px;';
                placeholder.textContent = 'üë§';
                this.parentNode.insertBefore(placeholder, this);
            };
            
            const span = document.createElement('span');
            span.textContent = u.name || u.username;
            
            label.appendChild(radio);
            label.appendChild(img);
            label.appendChild(span);
            
            label.addEventListener('mouseenter', () => {
                if (!radio.disabled) label.style.background = 'rgba(255,255,255,0.1)';
            });
            label.addEventListener('mouseleave', () => {
                if (!radio.disabled) label.style.background = 'rgba(255,255,255,0.05)';
            });
            
            userRadioContainer.appendChild(label);
        });
        
        // Show accept/decline buttons if chore is assigned to current user but not created by them
        const acceptDeclineDiv = document.getElementById('chore-accept-decline');
        if (acceptDeclineDiv) {
            acceptDeclineDiv.remove();
        }
        
        if (isAuthenticated && chore.assigned_user_id === currentUserId && !isAdmin) {
            const acceptDeclineHTML = `
                <div id="chore-accept-decline" style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid var(--glass-border);">
                    <p style="margin: 0 0 8px 0; color: var(--text-primary); font-weight: 500;">This chore has been assigned to you</p>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" onclick="acceptChore(${chore.id})" 
                                style="flex: 1; padding: 8px 16px; border-radius: 6px; border: none; 
                                       background: rgba(34, 197, 94, 0.8); color: white; cursor: pointer; font-weight: 600;">
                            Accept
                        </button>
                        <button type="button" onclick="declineChore(${chore.id})" 
                                style="flex: 1; padding: 8px 16px; border-radius: 6px; border: none; 
                                       background: rgba(239, 68, 68, 0.8); color: white; cursor: pointer; font-weight: 600;">
                            Decline
                        </button>
                    </div>
                </div>
            `;
            const form = document.getElementById('chore-edit-form');
            form.insertAdjacentHTML('afterbegin', acceptDeclineHTML);
        }
        
        // Populate room dropdown
        const roomSelect = document.getElementById('chore-edit-room');
        roomSelect.innerHTML = '<option value="">No Room</option>';
        rooms.forEach(r => {
            const option = document.createElement('option');
            option.value = r.id;
            option.textContent = r.name;
            if (chore.room_id === r.id) option.selected = true;
            roomSelect.appendChild(option);
        });
        
        document.getElementById('chore-edit-id').value = chore.id;
        document.getElementById('chore-tracker-id').value = tracker ? tracker.id : '';
        document.getElementById('chore-edit-task').value = chore.task || '';
        document.getElementById('chore-edit-reward').value = chore.reward || 0;
        const dueByEl = document.getElementById('chore-edit-due-by');
        if (dueByEl && tracker) {
            const d = tracker.due_by_date || tracker.date;
            dueByEl.value = d ? String(d).slice(0, 10) : '';
        } else if (dueByEl) {
            dueByEl.value = '';
        }
        const currentStatus = tracker ? (tracker.status || 'pending') : 'pending';
        document.getElementById('chore-edit-status').value = currentStatus;
        
        // Show assigner notes if they exist
        const assignerNotesSection = document.getElementById('chore-assigner-notes-section');
        const assignerNotesEl = document.getElementById('chore-assigner-notes');
        if (tracker && tracker.assigner_notes) {
            if (assignerNotesSection) assignerNotesSection.style.display = 'block';
            if (assignerNotesEl) assignerNotesEl.value = tracker.assigner_notes;
        } else {
            if (assignerNotesSection) assignerNotesSection.style.display = 'none';
            if (assignerNotesEl) assignerNotesEl.value = '';
        }
        
        // Show approval actions if current user is assigner and status is pending_approval
        // If assigned_by_id is not set, assume admin is the assigner
        const approvalActions = document.getElementById('chore-approval-actions');
        const isAssigner = (chore.assigned_by_id && chore.assigned_by_id === CURRENT_USER_ID) || 
                          (!chore.assigned_by_id && IS_ADMIN && chore.assigned_user_id && chore.assigned_user_id !== CURRENT_USER_ID);
        if (approvalActions && isAssigner && currentStatus === 'pending_approval') {
            approvalActions.style.display = 'block';
        } else if (approvalActions) {
            approvalActions.style.display = 'none';
        }
        
        const choreUpdatedEl = document.getElementById('chore-edit-updated');
        if (choreUpdatedEl && tracker && tracker.updated_by_name && tracker.updated_at) {
            const d = new Date(tracker.updated_at);
            choreUpdatedEl.textContent = 'Last updated by ' + tracker.updated_by_name + ' on ' + d.toLocaleDateString() + ' at ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            choreUpdatedEl.style.display = 'block';
        } else if (choreUpdatedEl) {
            choreUpdatedEl.textContent = '';
            choreUpdatedEl.style.display = 'none';
        }
        const readOnly = !AUTHENTICATED;
        const taskEl = document.getElementById('chore-edit-task');
        if (taskEl) taskEl.readOnly = readOnly;
        const rewardEl = document.getElementById('chore-edit-reward');
        if (rewardEl) rewardEl.readOnly = readOnly;
        if (dueByEl) dueByEl.readOnly = readOnly;
        const statusEl = document.getElementById('chore-edit-status');
        // Disable status dropdown if assignee and status is pending_approval (can't change it)
        if (statusEl) {
            const isAssignee = chore.assigned_user_id && chore.assigned_user_id === CURRENT_USER_ID;
            statusEl.disabled = readOnly || (isAssignee && currentStatus === 'pending_approval');
        }
        // Store original values for change detection
        const originalValues = {
            task: chore.task || '',
            assigned_user_id: chore.assigned_user_id || null,
            room_id: chore.room_id || null,
            reward: chore.reward || 0,
            status: tracker ? (tracker.status || 'pending') : 'pending',
            due_by_date: tracker && tracker.due_by_date ? String(tracker.due_by_date).slice(0, 10) : (tracker && tracker.date ? String(tracker.date).slice(0, 10) : '')
        };
        modal.dataset.originalValues = JSON.stringify(originalValues);
        
        // Function to check if form has changes
        function checkForChanges() {
            if (!AUTHENTICATED) return false;
            
            const currentTask = document.getElementById('chore-edit-task').value;
            const currentReward = parseFloat(document.getElementById('chore-edit-reward').value) || 0;
            const currentRoom = document.getElementById('chore-edit-room').value || null;
            const currentStatus = document.getElementById('chore-edit-status').value;
            const currentDueBy = document.getElementById('chore-edit-due-by').value || '';
            const selectedUser = document.querySelector('input[name="chore-assigned-user"]:checked');
            const currentAssignedUserId = selectedUser ? (selectedUser.value ? parseInt(selectedUser.value) : null) : null;
            
            const hasChanges = 
                currentTask !== originalValues.task ||
                currentAssignedUserId !== originalValues.assigned_user_id ||
                (currentRoom ? parseInt(currentRoom) : null) !== originalValues.room_id ||
                currentReward !== originalValues.reward ||
                currentStatus !== originalValues.status ||
                currentDueBy !== originalValues.due_by_date;
            
            const saveBtn = document.getElementById('chore-edit-save-btn');
            const closeBtn = document.getElementById('chore-edit-close-btn');
            
            if (saveBtn && closeBtn) {
                if (hasChanges) {
                    saveBtn.style.display = '';
                    closeBtn.style.display = 'none';
                } else {
                    saveBtn.style.display = 'none';
                    closeBtn.style.display = '';
                }
            }
            
            return hasChanges;
        }
        
        // Add change listeners to all form fields
        const form = document.getElementById('chore-edit-form');
        const formFields = form.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            field.addEventListener('change', checkForChanges);
            field.addEventListener('input', checkForChanges);
        });
        
        // Initial check
        checkForChanges();
        
        const deleteBtn = document.getElementById('chore-edit-delete-btn');
        const saveBtn = document.getElementById('chore-edit-save-btn');
        const saveLoginBtn = document.getElementById('chore-edit-save-login-btn');
        const closeBtn = document.getElementById('chore-edit-close-btn');
        if (deleteBtn) deleteBtn.style.display = AUTHENTICATED ? '' : 'none';
        if (saveBtn) saveBtn.style.display = AUTHENTICATED ? 'none' : 'none'; // Will be shown by checkForChanges
        if (closeBtn) closeBtn.style.display = AUTHENTICATED ? '' : 'none';
        if (saveLoginBtn) saveLoginBtn.style.display = AUTHENTICATED ? 'none' : '';
        document.getElementById('edit-chore-modal').style.display = 'flex';
    }
    
    function closeEventModal() {
        document.getElementById('edit-event-modal').style.display = 'none';
    }
    // Expose to global scope for onclick handlers
    window.closeEventModal = closeEventModal;
    
    function closeChoreModal() {
        document.getElementById('edit-chore-modal').style.display = 'none';
    }
    // Expose to global scope for onclick handlers
    window.closeChoreModal = closeChoreModal;
    
    function approveChoreCompletion() {
        const trackerId = document.getElementById('chore-tracker-id').value;
        if (!trackerId) {
            alert('No tracker entry found.');
            return;
        }
        
        fetch(`/chores/tracker/${trackerId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(err => Promise.reject(new Error(err.error || 'Failed to approve')));
            }
            return r.json();
        })
        .then(updatedTracker => {
            const trackerIndex = choreTrackers.findIndex(ct => ct.id === parseInt(trackerId));
            if (trackerIndex !== -1) {
                choreTrackers[trackerIndex] = updatedTracker;
            }
            loadCalendarData();
            closeChoreModal();
        })
        .catch(err => {
            console.error('Error approving chore:', err);
            alert('Failed to approve chore: ' + err.message);
        });
    }
    window.approveChoreCompletion = approveChoreCompletion;
    
    function openReinstateModal() {
        const notes = prompt('Add notes for reinstating this chore (optional):');
        if (notes === null) return; // User cancelled
        
        const trackerId = document.getElementById('chore-tracker-id').value;
        if (!trackerId) {
            alert('No tracker entry found.');
            return;
        }
        
        fetch(`/chores/tracker/${trackerId}/reinstate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes || '' })
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(err => Promise.reject(new Error(err.error || 'Failed to reinstate')));
            }
            return r.json();
        })
        .then(updatedTracker => {
            const trackerIndex = choreTrackers.findIndex(ct => ct.id === parseInt(trackerId));
            if (trackerIndex !== -1) {
                choreTrackers[trackerIndex] = updatedTracker;
            }
            loadCalendarData();
            closeChoreModal();
        })
        .catch(err => {
            console.error('Error reinstating chore:', err);
            alert('Failed to reinstate chore: ' + err.message);
        });
    }
    window.openReinstateModal = openReinstateModal;
    
    function saveEvent(event) {
        event.preventDefault();
        const eventId = document.getElementById('event-edit-id').value;
        const eventData = {
            title: document.getElementById('event-edit-title').value,
            date: document.getElementById('event-edit-date').value,
            time: document.getElementById('event-edit-time').value || null,
            description: document.getElementById('event-edit-description').value,
            event_type: document.getElementById('event-edit-type').value || null
        };
        
        fetch(`/events/api/${eventId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
        })
        .then(r => {
            if (r.ok) {
                return r.json();
            }
            throw new Error('Failed to update event');
        })
        .then(data => {
            const index = events.findIndex(e => e.id === parseInt(eventId));
            if (index !== -1) {
                events[index] = data;
            }
            // Update allEventsList as well
            const allIndex = allEventsList.findIndex(e => e.id === parseInt(eventId));
            if (allIndex !== -1) {
                allEventsList[allIndex] = data;
            }
            closeEventModal();
            if (isListView) {
                renderListView();
            } else {
                renderCalendar();
            }
        })
        .catch(err => {
            console.error('Error updating event:', err);
            alert('Failed to update event. Please try again.');
        });
    }
    // Expose to global scope for onclick handlers
    window.saveEvent = saveEvent;
    
    function saveChore(event) {
        event.preventDefault();
        const choreId = parseInt(document.getElementById('chore-edit-id').value);
        const trackerId = document.getElementById('chore-tracker-id').value ? parseInt(document.getElementById('chore-tracker-id').value) : null;
        const selectedUser = document.querySelector('input[name="chore-assigned-user"]:checked');
        const choreData = {
            task: document.getElementById('chore-edit-task').value,
            assigned_user_id: selectedUser ? (selectedUser.value ? parseInt(selectedUser.value) : null) : null,
            room_id: document.getElementById('chore-edit-room').value ? parseInt(document.getElementById('chore-edit-room').value) : null,
            reward: parseFloat(document.getElementById('chore-edit-reward').value) || 0,
            frequency: 'once'
        };
        const status = document.getElementById('chore-edit-status').value;
        const dueByEl = document.getElementById('chore-edit-due-by');
        const dueByVal = dueByEl && dueByEl.value ? dueByEl.value : null;
        
        // Determine the actual status to save
        // If assignee marks as "completed", change it to "pending_approval"
        const chore = chores.find(c => c.id === choreId);
        const isAssignee = chore && chore.assigned_user_id && chore.assigned_user_id === CURRENT_USER_ID;
        const isAssigner = chore && chore.assigned_by_id && chore.assigned_by_id === CURRENT_USER_ID;
        let statusToSave = status;
        
        // If assignee is marking as completed, change to pending_approval
        if (status === 'completed' && isAssignee && !isAssigner) {
            statusToSave = 'pending_approval';
        }
        
        // Always update the chore first
        fetch(`/chores/api/${choreId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(choreData)
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(err => Promise.reject(new Error(err.error || 'Failed to update chore')));
            }
            return r.json();
        })
        .then(updatedChore => {
            // Update local chores array
            const index = chores.findIndex(c => c.id === choreId);
            if (index !== -1) {
                chores[index] = updatedChore;
            } else {
                chores.push(updatedChore);
            }
            
            // Update or create tracker entry
            if (trackerId) {
                // Update existing tracker
                const trackerPayload = { status: statusToSave };
                if (dueByVal) trackerPayload.due_by_date = dueByVal;
                return fetch(`/chores/tracker/${trackerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(trackerPayload)
                })
                .then(r => {
                    if (!r.ok) {
                        return r.json().then(err => Promise.reject(new Error(err.error || 'Failed to update tracker')));
                    }
                    return r.json();
                })
                .then(updatedTracker => {
                    const trackerIndex = choreTrackers.findIndex(ct => ct.id === trackerId);
                    if (trackerIndex !== -1) {
                        choreTrackers[trackerIndex] = updatedTracker;
                    } else {
                        choreTrackers.push(updatedTracker);
                    }
                    
                    if (statusToSave === 'completed' || statusToSave === 'pending_approval') {
                        // Reload calendar data for completed/pending approval chores
                        loadCalendarData();
                    } else {
                        renderCalendar();
                        if (isListView) renderListView();
                    }
                    closeChoreModal();
                });
            } else {
                // No tracker exists - create one if status is not pending, or if due_by_date is set
                if (status && status !== 'pending' || dueByVal) {
                    const today = new Date().toISOString().split('T')[0];
                    return fetch('/chores/tracker', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chore_id: choreId,
                            date: today,
                            status: status || 'pending',
                            due_by_date: dueByVal || null
                        })
                    })
                    .then(r => {
                        if (!r.ok) {
                            return r.json().then(err => Promise.reject(new Error(err.error || 'Failed to create tracker')));
                        }
                        return r.json();
                    })
                    .then(newTracker => {
                        choreTrackers.push(newTracker);
                        renderCalendar();
                        if (isListView) renderListView();
                        closeChoreModal();
                    });
                } else {
                    // Just close if no tracker needed
                    renderCalendar();
                    if (isListView) renderListView();
                    closeChoreModal();
                }
            }
        })
        .catch(err => {
            console.error('Error saving chore:', err);
            alert('Failed to save chore: ' + (err.message || 'Unknown error'));
        });
    }
    // Expose to global scope for form submission
    window.saveChore = saveChore;
    
    function deleteEvent() {
        if (!confirm('Are you sure you want to delete this event?')) return;
        
        const eventId = document.getElementById('event-edit-id').value;
        fetch(`/events/api/${eventId}`, {
            method: 'DELETE'
        })
        .then(r => {
            if (r.ok) {
                events = events.filter(e => e.id !== parseInt(eventId));
                closeEventModal();
                renderCalendar();
            } else {
                throw new Error('Failed to delete event');
            }
        })
        .catch(err => {
            console.error('Error deleting event:', err);
            alert('Failed to delete event. Please try again.');
        });
    }
    
    function acceptChore(choreId) {
        // Accepting a chore means keeping the assignment
        closeChoreModal();
        if (isListView) {
            renderListView();
        } else {
            renderCalendar();
        }
    }
    
    function declineChore(choreId) {
        if (!confirm('Are you sure you want to decline this chore? It will be unassigned.')) return;
        
        fetch(`/chores/api/${choreId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assigned_user_id: null })
        })
        .then(r => {
            if (r.ok) {
                return r.json();
            }
            throw new Error('Failed to decline chore');
        })
        .then(data => {
            const index = chores.findIndex(c => c.id === parseInt(choreId));
            if (index !== -1) {
                chores[index] = data;
            }
            closeChoreModal();
            loadChoreTracker().then(() => {
                if (isListView) {
                    renderListView();
                } else {
                    renderCalendar();
                }
            });
        })
        .catch(err => {
            console.error('Error declining chore:', err);
            alert('Failed to decline chore. Please try again.');
        });
    }
    
    function deleteChore() {
        if (!confirm('Are you sure you want to delete this chore?')) return;
        
        const choreId = document.getElementById('chore-edit-id').value;
        fetch(`/chores/api/${choreId}`, {
            method: 'DELETE'
        })
        .then(r => {
            if (r.ok) {
                chores = chores.filter(c => c.id !== parseInt(choreId));
                choreTrackers = choreTrackers.filter(ct => ct.chore_id !== parseInt(choreId));
                closeChoreModal();
                if (isListView) {
                    renderListView();
                } else {
                    renderCalendar();
                }
            } else {
                throw new Error('Failed to delete chore');
            }
        })
        .catch(err => {
            console.error('Error deleting chore:', err);
            alert('Failed to delete chore. Please try again.');
        });
    }
    
    function showPasswordPrompt(title, date) {
        const modal = document.getElementById('login-modal');
        if (!modal) {
            // Create modal if it doesn't exist
            const modalHTML = `
                <div id="login-modal" class="modal-overlay" style="display: none;">
                    <div class="modal-content glass-card">
                        <h3>Login to Create Event</h3>
                        <p id="modal-event-info" style="margin: 12px 0; color: var(--text-secondary);"></p>
                        <form id="login-form" onsubmit="handleQuickLogin(event)">
                            <div style="margin-bottom: 16px;">
                                <label for="modal-username" style="display: block; margin-bottom: 8px; color: var(--text-primary);">Username</label>
                                <input type="text" id="modal-username" name="username" required 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="modal-password" style="display: block; margin-bottom: 8px; color: var(--text-primary);">Password</label>
                                <input type="password" id="modal-password" name="password" required 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                              background: rgba(255,255,255,0.1); color: var(--text-primary);">
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="closeLoginModal()" 
                                        style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); 
                                               background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="padding: 10px 20px; border-radius: 8px; border: none; 
                                               background: rgba(59, 130, 246, 0.8); color: white; cursor: pointer; font-weight: 600;">
                                    Login & Create
                                </button>
                            </div>
                        </form>
                        <div id="modal-error" style="margin-top: 12px; color: #ef4444; display: none;"></div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        document.getElementById('modal-event-info').textContent = `Create "${title}" on ${new Date(date).toLocaleDateString()}`;
        document.getElementById('modal-username').value = '';
        document.getElementById('modal-password').value = '';
        document.getElementById('modal-error').style.display = 'none';
        document.getElementById('login-modal').style.display = 'flex';
        document.getElementById('modal-username').focus();
        
        // Store event data for after login
        window.pendingEvent = { title, date };
    }
    
    function closeLoginModal() {
        document.getElementById('login-modal').style.display = 'none';
        window.pendingEvent = null;
    }
    
    function handleQuickLogin(event) {
        event.preventDefault();
        const username = document.getElementById('modal-username').value;
        const password = document.getElementById('modal-password').value;
        const errorDiv = document.getElementById('modal-error');
        
        // Try to login with JSON response
        fetch('/auth/login', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`,
            credentials: 'same-origin'
        })
        .then(r => {
            if (r.ok) {
                return r.json();
            } else {
                return r.json().then(err => { throw new Error(err.error || 'Login failed'); });
            }
        })
        .then(data => {
            if (data.success) {
                // Login successful, now create the event
                if (window.pendingEvent) {
                    return fetch('/events/api', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: window.pendingEvent.title,
                            date: window.pendingEvent.date,
                            description: `Quick event created from dashboard`
                        }),
                        credentials: 'same-origin'
                    });
                }
            } else {
                throw new Error(data.error || 'Login failed');
            }
        })
        .then(r => {
            if (r && r.ok) {
                return r.json();
            }
            throw new Error('Failed to create event');
        })
        .then(data => {
            closeLoginModal();
            // Add event to local array and show edit popup
            events.push(data);
            renderCalendar();
            setTimeout(() => editEvent(data.id), 100);
        })
        .catch(err => {
            errorDiv.textContent = err.message || 'Invalid username or password. Please try again.';
            errorDiv.style.display = 'block';
        });
    }
    
    // Event magnet drag and drop
    document.addEventListener('DOMContentLoaded', () => {
        const magnets = document.querySelectorAll('.event-magnet');
        
        magnets.forEach(magnet => {
            magnet.addEventListener('dragstart', (e) => {
                // Stop propagation to prevent section dragging
                e.stopPropagation();
                draggedMagnet = magnet;
                magnet.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            magnet.addEventListener('dragend', () => {
                magnet.classList.remove('dragging');
                draggedMagnet = null;
                // Remove drag-over class from all calendar days
                document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('drag-over');
                });
            });
        });
    });
    
    // Section drag and drop
    let draggedSection = null;
    
    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('.draggable-section');
        const container = document.getElementById('dashboard-container');
        
        sections.forEach(section => {
            section.addEventListener('dragstart', (e) => {
                // Don't drag section if dragging a magnet
                if (e.target.classList.contains('event-magnet') || e.target.closest('.event-magnet')) {
                    e.preventDefault();
                    return;
                }
                if (e.target.classList.contains('drag-handle') || e.target.closest('.drag-handle') || e.offsetY < 20) {
                    draggedSection = section;
                    section.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                } else {
                    e.preventDefault();
                }
            });
            
            section.addEventListener('dragend', () => {
                if (draggedSection) {
                    draggedSection.classList.remove('dragging');
                    saveLayout();
                    draggedSection = null;
                }
            });
            
            section.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedSection) return;
                
                const afterElement = getDragAfterSection(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedSection);
                } else {
                    container.insertBefore(draggedSection, afterElement);
                }
            });
        });
        
        loadLayout();
    });
    
    function getDragAfterSection(container, y) {
        const sections = [...container.querySelectorAll('.draggable-section:not(.dragging)')];
        
        return sections.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    function saveLayout() {
        const container = document.getElementById('dashboard-container');
        const sections = Array.from(container.querySelectorAll('.draggable-section'));
        const layout = sections.map(section => section.dataset.section);
        localStorage.setItem('dashboard_layout', JSON.stringify(layout));
    }
    
    function loadLayout() {
        const saved = localStorage.getItem('dashboard_layout');
        if (!saved) return;
        
        try {
            const layout = JSON.parse(saved);
            const container = document.getElementById('dashboard-container');
            const sections = Array.from(container.querySelectorAll('.draggable-section'));
            const sectionMap = {};
            sections.forEach(s => sectionMap[s.dataset.section] = s);
            
            layout.forEach(sectionName => {
                if (sectionMap[sectionName]) {
                    container.appendChild(sectionMap[sectionName]);
                }
            });
        } catch (e) {
            console.error('Error loading layout:', e);
        }
    }
    
    // Quick events and chores from database
    let quickEventIds = [];
    let quickChoreIds = [];
    let allChoresList = [];
    let allEventsList = [];
    
    // Helper function to extract emoji from task name
    function extractEmoji(text) {
        if (!text) return '‚úÖ';
        // Match emoji at the start of the string
        const emojiRegex = /^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u;
        const match = text.match(emojiRegex);
        if (match) {
            return match[0];
        }
        // Check if there's an emoji anywhere in the string
        const emojiInText = text.match(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u);
        if (emojiInText) {
            return emojiInText[0];
        }
        return '‚úÖ'; // Default icon
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function getQuickEvents() {
        // Fetch user's selected quick event IDs
        try {
            const response = await fetch('/settings/api/quick-events');
            if (response.ok) {
                const data = await response.json();
                quickEventIds = data.event_ids || [];
                console.log('Loaded quick event IDs:', quickEventIds);
            } else {
                console.error('Failed to load quick events:', response.status);
                quickEventIds = [];
            }
        } catch (e) {
            console.error('Error loading quick events:', e);
            quickEventIds = [];
        }
        
        // Map IDs to event objects
        return quickEventIds.map(id => {
            const event = allEventsList.find(e => e.id === id);
            if (event) {
                return {
                    id: event.id,
                    title: event.title,
                    type: event.event_type || 'event',
                    icon: extractEmoji(event.title)
                };
            }
            return null;
        }).filter(e => e !== null);
    }
    
    async function getQuickChores() {
        // Fetch user's selected quick chore IDs
        try {
            const response = await fetch('/settings/api/quick-chores');
            if (response.ok) {
                const data = await response.json();
                quickChoreIds = data.chore_ids || [];
                console.log('Loaded quick chore IDs:', quickChoreIds);
            } else {
                console.error('Failed to load quick chores:', response.status);
                quickChoreIds = [];
            }
        } catch (e) {
            console.error('Error loading quick chores:', e);
            quickChoreIds = [];
        }
        
        // Map IDs to chore objects
        return quickChoreIds.map(id => {
            const chore = allChoresList.find(c => c.id === id);
            if (chore) {
                return {
                    id: chore.id,
                    task: chore.task,
                    icon: extractEmoji(chore.task)
                };
            }
            return null;
        }).filter(c => c !== null);
    }
    
    async function loadAllChores() {
        try {
            const response = await fetch('/chores/api?all=1');
            if (response.ok) {
                const data = await response.json();
                allChoresList = Array.isArray(data) ? data : [];
            }
        } catch (e) {
            console.error('Error loading all chores:', e);
            allChoresList = [];
        }
    }
    
    async function loadAllEvents() {
        try {
            const response = await fetch('/events/api');
            if (response.ok) {
                const data = await response.json();
                allEventsList = Array.isArray(data) ? data : [];
            }
        } catch (e) {
            console.error('Error loading all events:', e);
            allEventsList = [];
        }
    }
    
    let isEditingQuickChores = false;
    let isEditingQuickEvents = false;
    
    async function renderQuickMagnets() {
        const eventsContainer = document.getElementById('quick-events-container');
        const choresContainer = document.getElementById('quick-chores-container');
        if (!eventsContainer || !choresContainer) return;
        
        // Load quick chore IDs and quick event IDs first
        await getQuickChores();
        await getQuickEvents();
        
        // Render ALL events as magnets, but hide unselected ones when not editing
        eventsContainer.innerHTML = '';
        if (allEventsList.length === 0) {
            eventsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px; font-size: 14px;">No events available</p>';
        } else {
            // Ensure quickEventIds is loaded (should be from getQuickEvents call above)
            console.log('Rendering with quickEventIds:', quickEventIds);
            
            allEventsList.forEach(event => {
                const isSelected = quickEventIds.includes(event.id);
                const icon = extractEmoji(event.title);
                const div = document.createElement('div');
                div.className = 'event-magnet' + (isSelected ? ' selected' : '');
                div.dataset.eventId = event.id;
                div.dataset.eventTitle = event.title;
                div.dataset.eventType = event.event_type || 'event';
                div.dataset.eventIcon = icon;
                
                // Hide if not selected and not editing
                if (!isSelected && !isEditingQuickEvents) {
                    div.style.display = 'none';
                }
                
                // Show visual indicator when selected
                if (isSelected) {
                    div.style.opacity = '1';
                    div.style.border = '2px solid rgba(59, 130, 246, 0.5)';
                } else if (isEditingQuickEvents) {
                    div.style.opacity = '0.5';
                    div.style.border = '1px solid var(--glass-border)';
                }
                
                div.draggable = !isEditingQuickEvents; // Disable dragging when editing
                div.dataset.magnetType = 'event';
                div.textContent = icon || 'üìÖ';
                div.title = event.title + (isEditingQuickEvents ? ' - Click to toggle selection' : ' - Click to add to calendar (or drag to a day)');
                
                if (!isEditingQuickEvents) {
                    // Normal behavior: drag and click to add to calendar
                    div.addEventListener('dragstart', function(e) {
                        e.stopPropagation();
                        draggedMagnet = this;
                        this.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', 'event:' + event.id);
                    });
                    div.addEventListener('dragend', function() { draggedMagnet = null; this.classList.remove('dragging'); });
                    div.addEventListener('click', function() {
                        const today = new Date();
                        const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                        const preselect = 'event:' + event.id;
                        openAddForDayModal(todayStr, preselect);
                    });
                } else {
                    // Edit mode: click to toggle selection
                    div.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleEventSelection(event.id, div);
                    });
                }
                
                eventsContainer.appendChild(div);
            });
        }
        
        // Render ALL chores as magnets, but hide unselected ones when not editing
        choresContainer.innerHTML = '';
        if (allChoresList.length === 0) {
            choresContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px; font-size: 14px;">No chores available</p>';
            return;
        }
        
        // Ensure quickChoreIds is loaded (should be from getQuickChores call above)
        console.log('Rendering with quickChoreIds:', quickChoreIds);
        
        allChoresList.forEach(chore => {
            const isSelected = quickChoreIds.includes(chore.id);
            const icon = extractEmoji(chore.task);
            const div = document.createElement('div');
            div.className = 'event-magnet chore-magnet' + (isSelected ? ' selected' : '');
            div.dataset.choreId = chore.id;
            div.dataset.choreTask = chore.task;
            div.dataset.choreIcon = icon;
            
            // Hide if not selected and not editing
            if (!isSelected && !isEditingQuickChores) {
                div.style.display = 'none';
            }
            
            // Show visual indicator when selected
            if (isSelected) {
                div.style.opacity = '1';
                div.style.border = '2px solid rgba(59, 130, 246, 0.5)';
            } else if (isEditingQuickChores) {
                div.style.opacity = '0.5';
                div.style.border = '1px solid var(--glass-border)';
            }
            
            div.draggable = !isEditingQuickChores; // Disable dragging when editing
            div.dataset.magnetType = 'chore';
            div.textContent = icon || '‚úÖ';
            div.title = chore.task + (isEditingQuickChores ? ' - Click to toggle selection' : ' - Click to add to calendar (or drag to a day)');
            
            if (!isEditingQuickChores) {
                // Normal behavior: drag and click to add to calendar
                div.addEventListener('dragstart', function(e) {
                    e.stopPropagation();
                    draggedMagnet = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', 'chore:' + chore.id);
                });
                div.addEventListener('dragend', function() { draggedMagnet = null; this.classList.remove('dragging'); });
                div.addEventListener('click', function() {
                    const today = new Date();
                    const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                    const preselect = 'chore:' + chore.id;
                    openAddForDayModal(todayStr, preselect);
                });
            } else {
                // Edit mode: click to toggle selection
                div.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleChoreSelection(chore.id, div);
                });
            }
            
            choresContainer.appendChild(div);
        });
    }
    
    function toggleChoreSelection(choreId, element) {
        const index = quickChoreIds.indexOf(choreId);
        const currentlySelected = quickChoreIds.filter(id => id !== choreId).length;
        
        if (index === -1) {
            // Trying to select
            if (currentlySelected >= 8) {
                alert('You can only select up to 8 quick chores. Please deselect one first.');
                return;
            }
            quickChoreIds.push(choreId);
            element.classList.add('selected');
            element.style.opacity = '1';
            element.style.border = '2px solid rgba(59, 130, 246, 0.5)';
        } else {
            // Deselecting
            quickChoreIds.splice(index, 1);
            element.classList.remove('selected');
            element.style.opacity = '0.5';
            element.style.border = '1px solid var(--glass-border)';
        }
    }
    
    function toggleEventSelection(eventId, element) {
        const index = quickEventIds.indexOf(eventId);
        const currentlySelected = quickEventIds.filter(id => id !== eventId).length;
        
        if (index === -1) {
            // Trying to select
            if (currentlySelected >= 8) {
                alert('You can only select up to 8 quick events. Please deselect one first.');
                return;
            }
            quickEventIds.push(eventId);
            element.classList.add('selected');
            element.style.opacity = '1';
            element.style.border = '2px solid rgba(59, 130, 246, 0.5)';
        } else {
            // Deselecting
            quickEventIds.splice(index, 1);
            element.classList.remove('selected');
            element.style.opacity = '0.5';
            element.style.border = '1px solid var(--glass-border)';
        }
    }
    
    async function addQuickEvent() {
        if (isEditingQuickEvents) {
            // Save changes
            if (quickEventIds.length > 8) {
                alert('You can only select up to 8 quick events. Please deselect some.');
                return;
            }
            
            try {
                const response = await fetch('/settings/api/quick-events', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_ids: quickEventIds })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Update quickEventIds with the saved IDs
                    quickEventIds = result.event_ids || quickEventIds;
                    console.log('Saved quick event IDs:', quickEventIds);
                    isEditingQuickEvents = false;
                    const btn = document.getElementById('add-quick-event-btn');
                    if (btn) btn.textContent = '+ Add';
                    await renderQuickMagnets();
                } else {
                    console.error('Save failed:', result);
                    alert('Error saving quick events: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error saving quick events:', e);
                alert('Error saving quick events. Please try again.');
            }
        } else {
            // Enter edit mode - load current selections first
            await getQuickEvents();
            isEditingQuickEvents = true;
            const btn = document.getElementById('add-quick-event-btn');
            if (btn) btn.textContent = 'Save';
            await renderQuickMagnets();
        }
    }
    async function addQuickChore() {
        if (isEditingQuickChores) {
            // Save changes
            if (quickChoreIds.length > 8) {
                alert('You can only select up to 8 quick chores. Please deselect some.');
                return;
            }
            
            try {
                const response = await fetch('/settings/api/quick-chores', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chore_ids: quickChoreIds })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Update quickChoreIds with the saved IDs
                    quickChoreIds = result.chore_ids || quickChoreIds;
                    console.log('Saved quick chore IDs:', quickChoreIds);
                    isEditingQuickChores = false;
                    const btn = document.getElementById('add-quick-chore-btn');
                    if (btn) btn.textContent = '+ Add';
                    await renderQuickMagnets();
                } else {
                    console.error('Save failed:', result);
                    alert('Error saving quick chores: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error saving quick chores:', e);
                alert('Error saving quick chores. Please try again.');
            }
        } else {
            // Enter edit mode - load current selections first
            await getQuickChores();
            isEditingQuickChores = true;
            const btn = document.getElementById('add-quick-chore-btn');
            if (btn) btn.textContent = 'Save';
            await renderQuickMagnets();
        }
    }
    
    // Filter and calendar prev/next listeners
    document.addEventListener('DOMContentLoaded', () => {
        const typeFilter = document.getElementById('event-filter-type');
        const userFilter = document.getElementById('event-filter-user');
        
        if (typeFilter) {
            typeFilter.addEventListener('change', filterEvents);
        }
        if (userFilter) {
            userFilter.addEventListener('change', filterEvents);
        }
        
        const calendarPrev = document.getElementById('calendar-prev');
        const calendarNext = document.getElementById('calendar-next');
        if (calendarPrev) {
            calendarPrev.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                loadCalendarData();
            });
        }
        if (calendarNext) {
            calendarNext.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                loadCalendarData();
            });
        }
        
        document.getElementById('add-quick-event-btn')?.addEventListener('click', addQuickEvent);
        document.getElementById('add-quick-chore-btn')?.addEventListener('click', addQuickChore);
        
        // Load all chores and all events first, then load quick IDs, then render quick magnets
        Promise.all([loadAllChores(), loadAllEvents()]).then(async () => {
            // Now that allEventsList and allChoresList are populated, load quick IDs
            await Promise.all([getQuickChores(), getQuickEvents()]);
            await renderQuickMagnets();
        });
        
        // Delegated click for recurring chips (Parking, Trash, etc.) - avoids broken onclick quotes
        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            calendarEl.addEventListener('click', function(ev) {
                const chip = ev.target.closest('.calendar-event[data-recurring-date]');
                if (!chip) return;
                ev.preventDefault();
                ev.stopPropagation();
                const label = (chip.dataset.recurringLabel || '').replace(/&quot;/g, '"');
                const type = (chip.dataset.recurringType || 'event').replace(/&quot;/g, '"');
                const dateStr = chip.dataset.recurringDate || '';
                const eventId = chip.dataset.eventId ? parseInt(chip.dataset.eventId, 10) : null;
                if (dateStr) openRecurringTaskModal(label, type, dateStr, eventId);
            });
        }
    });
    
    // Initialize
    updateDateTime();
    updateGreeting();
    loadWeather();
    loadStats();
    loadCalendarData();
    if (AUTHENTICATED) loadUpcomingTasks();
    
    // Update time every minute
    setInterval(updateDateTime, 60000);
    })();
</script>
{% endblock %}
